-- =========================================================
-- (A) à¸£à¸­à¹€à¸à¸¡à¹‚à¸«à¸¥à¸”à¹ƒà¸«à¹‰à¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™
-- =========================================================
if not game:IsLoaded() then
    game.Loaded:Wait()
end

repeat task.wait() until game.Players.LocalPlayer
repeat task.wait() until game.Players.LocalPlayer:FindFirstChild("PlayerGui")
repeat task.wait() until game.Players.LocalPlayer.PlayerGui:FindFirstChild("spawn_units")
repeat task.wait() until game.Players.LocalPlayer:FindFirstChild("_stats")

-- =========================================================
-- (B) à¸›à¸£à¸°à¸à¸²à¸¨ Service/à¸•à¸±à¸§à¹à¸›à¸£à¸à¸·à¹‰à¸™à¸à¸²à¸™
-- =========================================================
local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService  = game:GetService("RunService")

local player      = Players.LocalPlayer
local char        = player.Character or player.CharacterAdded:Wait()

-- à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œ JSON à¹„à¸Ÿà¸¥à¹Œà¹€à¸”à¸µà¸¢à¸§
local SettingsFile = player.Name .. "_SHOPData.json"

-- =========================================================
-- (C) à¸•à¸²à¸£à¸²à¸‡à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ à¸«à¸²à¸à¹„à¸Ÿà¸¥à¹Œà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ à¸«à¸£à¸·à¸­à¹€à¸ªà¸µà¸¢
-- =========================================================
local DefaultData = {
    -- à¸ªà¹ˆà¸§à¸™ Settings à¸«à¸¥à¸±à¸
    ["WhiteScreen"] = true,

    -- à¸ªà¹ˆà¸§à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡ Webhook
    ["Webhook"]     = nil,
    ["DiscordID"]   = nil,

    ["MaxGems"]     = 0,
    ["OldGems"]     = 0,
    ["IsSended"]    = false,

    -- à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸ªà¹ˆà¸„à¹ˆà¸²à¸­à¸·à¹ˆà¸™ à¹† à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¹„à¸”à¹‰ à¹€à¸Šà¹ˆà¸™ ...
    -- ["SomeValue"] = ...
}

-- =========================================================
-- (D) à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹‚à¸«à¸¥à¸”/à¹€à¸‹à¸Ÿà¸„à¹ˆà¸² JSON
-- =========================================================
local function loadSettings()
    if isfile and isfile(SettingsFile) then
        local content = readfile(SettingsFile)
        local success, data = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if success and type(data) == "table" then
            return data
        else
            warn("[SHOPData] JSON à¹„à¸Ÿà¸¥à¹Œà¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢ => à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ")
        end
    end

    -- à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ à¹ƒà¸«à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ
    if writefile then
        writefile(SettingsFile, HttpService:JSONEncode(DefaultData))
    end
    return DefaultData
end

local function saveSettings(tbl)
    if writefile then
        local json = HttpService:JSONEncode(tbl)
        writefile(SettingsFile, json)
    else
        warn("[SHOPData] Executor à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š writefile => saveSettings() à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§")
    end
end

-- =========================================================
-- (E) à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ JSON
-- =========================================================
local LocalData   = loadSettings()

-- à¸”à¸¶à¸‡à¸•à¸±à¸§à¹à¸›à¸£à¸ˆà¸²à¸ LocalData (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸ˆà¸°à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¸ˆà¸²à¸ DefaultData)
local WhiteScreen = LocalData.WhiteScreen or false
local Webhook     = LocalData.Webhook
local DiscordID   = LocalData.DiscordID
local MaxGems     = LocalData.MaxGems
local OldGems     = LocalData.OldGems
local IsSended    = LocalData.IsSended

-- à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ nil
if OldGems == nil then OldGems = 0 end
if MaxGems == nil then MaxGems = 0 end
if IsSended == nil then IsSended = false end

-- =========================================================
-- (F) à¸›à¸£à¸°à¸à¸²à¸¨à¸•à¸±à¸§à¹à¸›à¸£ / à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸·à¹ˆà¸™ à¹† à¹€à¸”à¸´à¸¡
-- =========================================================
local WebhookEnd = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"
local ThumbnailURL = nil

-- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢à¸”à¸¶à¸‡à¸•à¸±à¸§à¹€à¸¥à¸‚à¸ˆà¸²à¸ string
local function GetNumberFromString(S)
    return string.match(S, "%d+")
end

-- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¶à¸‡à¸„à¹ˆà¸²à¸ˆà¸²à¸ Level Text
local function GetCurrentLevel(LevelText)
    if not LevelText then return "???" end
    return string.gsub(LevelText, "Level ", "")
end

-- =========================================================
-- (G) Get Thumbnail
-- =========================================================
local thumbRequest = syn and syn.request or request or http_request

pcall(function()
    thumbRequest = syn and syn.request or request or http_request
end)

if thumbRequest then
    local ThumbnailRequest = thumbRequest({
        Url = "https://thumbnails.roblox.com/v1/users/avatar-bust?userIds="
                .. tostring(player.UserId)
                .. "&size=420x420&format=Png&isCircular=false",
        Method = "GET",
        Headers = { ["Content-Type"] = "application/json" },
    })
    if ThumbnailRequest and ThumbnailRequest.Body then
        local decode = HttpService:JSONDecode(ThumbnailRequest.Body)
        if decode and decode.data and decode.data[1] then
            ThumbnailURL = decode.data[1].imageUrl
        end
    end
end

-- à¸–à¹‰à¸²à¸«à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¹ƒà¸«à¹‰à¹ƒà¸ªà¹ˆà¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¸§à¹ˆà¸²à¸‡
if ThumbnailURL == nil then
    ThumbnailURL = ""
end

print("[ThumbnailURL] =>", ThumbnailURL)

-- =========================================================
-- (H) à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™/à¹‚à¸„à¹‰à¸”à¸«à¸¥à¸±à¸à¹€à¸«à¸¡à¸·à¸­à¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¹€à¸”à¸´à¸¡
-- =========================================================

-- à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸¡à¸µ Webhook à¹„à¸«à¸¡
if Webhook and WebhookEnd then
    if game.PlaceId == 8304191830 then
        -- ===================== LOBBY (8304191830) =====================
        
        -- 1) Claim Gift
        pcall(function()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_daily_reward:InvokeServer()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_christmas_calendar_reward:InvokeServer()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_battlepass_rewards:InvokeServer()
        end)

        -- 2) à¸­à¸±à¸›à¹€à¸”à¸•à¸„à¹ˆà¸² Gems
        local currentgem = player["_stats"]["gem_amount"].Value
        if OldGems > 0 then
            if currentgem < OldGems then
                -- à¹ƒà¸Šà¹‰à¹€à¸à¸Šà¸£ => à¸«à¸±à¸à¸­à¸­à¸à¸ˆà¸²à¸ MaxGems
                MaxGems = MaxGems - (OldGems - currentgem)
                if MaxGems < 0 then MaxGems = 0 end
            end
        end
        OldGems = currentgem

        -- à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸¥à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ
        LocalData.MaxGems  = MaxGems
        LocalData.OldGems  = OldGems
        LocalData.IsSended = IsSended
        saveSettings(LocalData)

        -- 3) à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸–à¸¶à¸‡ Max à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
        if currentgem >= MaxGems and not IsSended and MaxGems > 0 then
            IsSended = true
            LocalData.IsSended = true
            saveSettings(LocalData)

            local LevelText = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text
            local userLevel = GetCurrentLevel(LevelText)

            local descriptionend = "**ğğ€ğŒğ„ :** ||%s||\n" ..
                                   "**ğŸ’ãƒ»ğ†ğ„ğŒğ’ : %s**\n" ..
                                   "**<a:2891bitcoin:1021469261274824764>ãƒ»ğ†ğğ‹ğƒ : %s**\n" ..
                                   "**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>ãƒ»ğ‹ğğ¯ğğ¥ : %s**\n\n" ..
                                   "à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸£à¸µà¸§à¸´à¸§à¸”à¹‰à¸§à¸¢à¸™à¹‰à¸²Â·Êšâ™¡ÉÂ·\n<#1009544224720568371>\n<#1021662378250752080>\n\n" ..
                                   "<a:emoji_98_jk:1054831096929452042> à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£à¸™à¹‰à¸² <a:8699rightrainbowstar:1054740408434966588>"

            -- à¸ªà¹ˆà¸‡ WebhookEnd
            if thumbRequest then
                thumbRequest({
                    Url = WebhookEnd,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "<@"..tostring(DiscordID).."> <@&1006505817769521177>",
                        embeds = {{
                            title       = "**à¸Ÿà¸²à¸¡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¹„à¸”à¹‰à¹€à¸¥à¸¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                            description = string.format(
                                descriptionend,
                                player.Name,
                                tostring(currentgem).." / "..tostring(MaxGems),
                                tostring(player["_stats"]["gold_amount"].Value),
                                userLevel
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { ["url"] = "" },
                            image       = { ["url"] = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end
        end

        -- 4) à¸ªà¹ˆà¸‡ Webhook à¸£à¸²à¸¢à¸‡à¸²à¸™
        do
            local GemNow   = player["_stats"]["gem_amount"].Value
            local GoldNow  = player["_stats"]["gold_amount"].Value
            local LevelNow = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text

            -- à¹€à¸à¹‡à¸šà¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸ˆà¸°à¹ƒà¸ªà¹ˆà¹ƒà¸™ description
            local description = " â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n**à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™** â‰§â–½â‰¦ <a:3018pinkheart:1019689700224684122>\n" ..
                                "\n**Name: **||%s||\n**à¹€à¸à¸Šà¸£ : ** **%s <a:8865diamond:1047145579790221433>**\n" ..
                                "**à¸—à¸­à¸‡ : ** **%s <a:2891bitcoin:1021469261274824764>**\n%s <a:5622bloodpotion:1047140829703180298> \n" ..
                                "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n**EXP à¸ˆà¸²à¸à¸”à¹ˆà¸²à¸™** <:4026pridepotion:1047140826897203311>\n"

            -- à¹€à¸à¹‡à¸šà¸„à¹ˆà¸² inventory à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™ (à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹ƒà¸™ original)
            local ResultValue = {
                ["Gem"]   = GemNow,
                ["gold"]  = GoldNow,
                ["Level"] = LevelNow,
            }


            -- à¸ªà¹ˆà¸‡ Webhook
            if thumbRequest then
                thumbRequest({
                    Url = Webhook,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "",
                        embeds = {{
                            title       = "**âœ¨ PLaNS SHOP âœ¨**",
                            description = string.format(
                                description,
                                player.Name,
                                ResultValue["Gem"].." / "..tostring(MaxGems),
                                ResultValue["gold"],
                                ResultValue["Level"]
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { url = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end

            -- à¸ªà¹ˆà¸‡ Webhook à¸­à¸µà¸à¸£à¸­à¸š "à¸•à¸­à¸™à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸¥à¹‡à¸­à¸šà¸šà¸µà¹‰"
            if thumbRequest then
                thumbRequest({
                    Url = Webhook,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "",
                        embeds = {{
                            title       = "**âœ¨ PLaNS SHOP âœ¨**",
                            description = "**ID: ||"..player.Name.."||**\n"..
                                          "<a:6132lightblueheartspin:1021711798203846717> à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸ªà¸–à¸²à¸™à¸° \n"..
                                          "<a:alert:1021734820461674527> à¹€à¸¥à¹ˆà¸™à¸ˆà¸šà¹à¸¥à¹‰à¸§à¸•à¸­à¸™à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸¥à¹‡à¸­à¸šà¸šà¸µà¹‰ (à¸«à¹‰à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ªà¸•à¸­à¸™à¸™à¸µà¹‰<a:4398qiqispin:1019693775515295824>)",
                            type        = "rich",
                            color       = tonumber(0xff0000),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { url = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end

    elseif game.PlaceId == 8349889591 then
        -- ===================== Story Mode (8349889591) =====================

        -- à¸–à¹‰à¸²à¹€à¸‚à¹‰à¸²à¸”à¹ˆà¸²à¸™ => à¹à¸ˆà¹‰à¸‡ webhook à¸§à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸Ÿà¸²à¸£à¹Œà¸¡
        if thumbRequest then
            thumbRequest({
                Url = Webhook,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    content = "",
                    embeds = {{
                        title       = "**âœ¨ PLaNS SHOP âœ¨**",
                        description = "**ID: ||"..player.Name.."||**\n"..
                                      "<a:6132lightblueheartspin:1021711798203846717> à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸ªà¸–à¸²à¸™à¸° \n"..
                                      "<a:7131discordverifygreen:1019693746998218804> à¸•à¸­à¸™à¸™à¸µà¹‰à¸à¸³à¸¥à¸±à¸‡à¸Ÿà¸²à¸¡à¹à¸¥à¹‰à¸§à¸™à¸° âœ¦",
                        type        = "rich",
                        color       = tonumber(0x55FF66),
                        footer      = {
                            text     = "PLaNS SHOP ",
                            icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                        },
                        thumbnail   = { url = ThumbnailURL },
                        timestamp   = DateTime.now():ToIsoDate(),
                    }}
                })
            })
        end

        -- à¹€à¸Šà¹‡à¸„ Gems à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
        local currentgem = player["_stats"]["gem_amount"].Value

        if OldGems > 0 then
            if currentgem < OldGems then
                MaxGems = MaxGems - (OldGems - currentgem)
                if MaxGems < 0 then MaxGems = 0 end
            end
        end
        OldGems = currentgem

        LocalData.MaxGems  = MaxGems
        LocalData.OldGems  = OldGems
        LocalData.IsSended = IsSended
        saveSettings(LocalData)

        -- à¸–à¹‰à¸²à¹€à¸à¸´à¸™ Max => à¸ªà¹ˆà¸‡ WebhookEnd
        if currentgem >= MaxGems and not IsSended and MaxGems > 0 then
            IsSended = true
            LocalData.IsSended = true
            saveSettings(LocalData)

            local LevelText = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text
            local userLevel = GetCurrentLevel(LevelText)

            local descriptionend = "**ğğ€ğŒğ„ :** ||%s||\n" ..
                                   "**ğŸ’ãƒ»ğ†ğ„ğŒğ’ : %s**\n" ..
                                   "**<a:2891bitcoin:1021469261274824764>ãƒ»ğ†ğğ‹ğƒ : %s**\n" ..
                                   "**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>ãƒ»ğ‹ğğ¯ğğ¥ : %s**\n\n" ..
                                   "à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸£à¸µà¸§à¸´à¸§à¸”à¹‰à¸§à¸¢à¸™à¹‰à¸²Â·Êšâ™¡ÉÂ·\n<#1009544224720568371>\n<#1021662378250752080>\n\n" ..
                                   "<a:emoji_98_jk:1054831096929452042> à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£à¸™à¹‰à¸² <a:8699rightrainbowstar:1054740408434966588>"

            if thumbRequest then
                thumbRequest({
                    Url = WebhookEnd,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "<@"..tostring(DiscordID).."> <@&1006505817769521177>",
                        embeds = {{
                            title       = "**à¸Ÿà¸²à¸¡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¹„à¸”à¹‰à¹€à¸¥à¸¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                            description = string.format(
                                descriptionend,
                                player.Name,
                                tostring(currentgem).." / "..tostring(MaxGems),
                                tostring(player["_stats"]["gold_amount"].Value),
                                userLevel
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { ["url"] = "" },
                            image       = { ["url"] = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end
        end

        -- à¹€à¸¡à¸·à¹ˆà¸­à¸ˆà¸šà¸”à¹ˆà¸²à¸™ => Workspace._DATA.GameFinished.Changed
        local wsGameFinished = game:GetService("Workspace")["_DATA"].GameFinished
        wsGameFinished.Changed:Connect(function()
            if wsGameFinished.Value == true then
                -- à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸¡à¸ˆà¸šà¸”à¹ˆà¸²à¸™ => à¸ªà¹ˆà¸‡à¸£à¸µà¸à¸­à¸£à¹Œà¸•à¸ªà¸£à¸¸à¸›
                local newgem = player["_stats"]["gem_amount"].Value
                if newgem < OldGems then
                    MaxGems = MaxGems - (OldGems - newgem)
                    if MaxGems < 0 then MaxGems = 0 end
                end
                OldGems = newgem

                LocalData.MaxGems  = MaxGems
                LocalData.OldGems  = OldGems
                LocalData.IsSended = IsSended
                saveSettings(LocalData)

                -- à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
                local PlayerGui    = player:WaitForChild("PlayerGui")
                local spawnUnits   = PlayerGui:WaitForChild("spawn_units")
                local resultsUI    = PlayerGui:WaitForChild("ResultsUI")
                local hatchInfo    = PlayerGui:WaitForChild("HatchInfo")

                local GemPath      = player["_stats"]["gem_amount"]
                local GoldPath     = player["_stats"]["gold_amount"]
                local KillsInGame  = player["_stats"].kills.Value

                local LevelText    = spawnUnits.Lives.Main.Desc.Level.Text
                local userLevel    = GetCurrentLevel(LevelText)

                local GemReward    = resultsUI.Holder.LevelRewards.ScrollingFrame.GemReward.Main.Amount.Text
                local XPReward     = resultsUI.Holder.LevelRewards.ScrollingFrame.XPReward.Main.Amount.Text
                local WaveCompleted= resultsUI.Holder.Middle.WavesCompleted.Text
                local TimeCompleted= resultsUI.Holder.Middle.Timer.Text
                local InfoGameEnd  = resultsUI.Holder.Title.Text

                local newArea      = PlayerGui:WaitForChild("NewArea")
                local MapTitle     = newArea.holder.areaTitle.Text
                local MapDesc      = newArea.holder.areaDescription.Text
                local Difficulty   = newArea.holder.Difficulty.Text

                -- à¸£à¸­ HatchInfo
                local AllItem = ""
                local buttonNext = resultsUI.Holder.Buttons.Next

                -- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸” next à¹€à¸£à¸·à¹ˆà¸­à¸¢ à¹†
                spawn(function()
                    while resultsUI.Holder.Visible do
                        task.wait(0.5)
                        pcall(function()
                            for _,c in pairs(getconnections(buttonNext.Activated)) do
                                c:Fire()
                            end
                        end)
                    end
                end)

                -- à¸”à¸±à¸à¹€à¸§à¸¥à¸²à¸¡à¸µà¸•à¸±à¸§à¸¥à¸°à¸„à¸£/à¹„à¸­à¹€à¸—à¹‡à¸¡ drop
                hatchInfo.holder.info1.UnitName:GetPropertyChangedSignal("Text"):Connect(function()
                    local itemName = hatchInfo.holder.info1.UnitName.Text
                    AllItem = AllItem .. ("â—ˆ " .. itemName .. "\n")
                end)

                local description = "ğŸ”’ Username : ||%s||\n```md\n#Profile\nğŸ’ Gems : %s\nğŸŸ¡ Golds : %s\nğŸ§ª Level: %s```\n"..
                                    "```md\n#Game Infomation\n- Game : %s\n- Map : %s\n- Difficuty : %s\n- Wave : %s | %s```\n"..
                                    "```md\n#Enemies Killed\n- %d```\n"..
                                    "```md\n#Rewards:\nâ—ˆ %s ğŸ’\nâ—ˆ %s ğŸ€\n%s```\n"..
                                    "```à¹€à¸à¸Šà¸£à¸£à¸§à¸¡ãƒ»%sğŸ’```"

                if thumbRequest then
                    thumbRequest({
                        Url = Webhook,
                        Method = "POST",
                        Headers = { ["Content-Type"] = "application/json" },
                        Body = HttpService:JSONEncode({
                            content = "",
                            embeds = {{
                                title       = "**<:9796zerogasm:1036348241656164394> PLaNS SHOP**",
                                description = string.format(
                                    description,
                                    player.Name,
                                    GemPath.Value,
                                    GoldPath.Value,
                                    userLevel,
                                    InfoGameEnd,
                                    MapTitle .. " : " .. MapDesc,
                                    Difficulty,
                                    string.match(WaveCompleted, "%d+"), -- à¸•à¸±à¸”à¹€à¸­à¸²à¹€à¸‰à¸à¸²à¸°à¸•à¸±à¸§à¹€à¸¥à¸‚
                                    TimeCompleted,
                                    KillsInGame,
                                    GemReward.." Gems",
                                    XPReward,
                                    AllItem,
                                    tostring(GemPath.Value).." / "..tostring(MaxGems)
                                ),
                                type        = "rich",
                                color       = tonumber(0x33FFCC),
                                footer      = {
                                    text     = "PLaNS SHOP ",
                                    icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                                },
                                thumbnail   = { url = "" },
                                timestamp   = DateTime.now():ToIsoDate(),
                            }}
                        })
                    })
                end
            end
        end)
    end
end

-- =========================================================
-- (I) à¸ªà¹ˆà¸§à¸™à¸ªà¸£à¹‰à¸²à¸‡ UI à¸”à¹‰à¸§à¸¢ Lib (à¸—à¸³à¸›à¸¸à¹ˆà¸¡/Toggle à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
-- =========================================================
local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI.lua'))()
local Window = Library:CreateWindow({
    Title    = "PLaNS SHOP",
    Center   = true, 
    AutoShow = true,
})

local Tabs    = Window:AddTab('PLaNS x SHOP')
local GroupBox= Tabs:AddLeftGroupbox('Settings')

-- Toggle White Screen (à¸­à¹ˆà¸²à¸™/à¹€à¸‚à¸µà¸¢à¸™ LocalData.WhiteScreen)
local whitescreenToggle = GroupBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = WhiteScreen,  -- à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹€à¸£à¸²à¹‚à¸«à¸¥à¸”à¸¡à¸²
})
whitescreenToggle:OnChanged(function(value)
    WhiteScreen = value
    LocalData.WhiteScreen = value
    saveSettings(LocalData)

    if value == true then
        RunService:Set3dRenderingEnabled(false)
    else
        RunService:Set3dRenderingEnabled(true)
    end
end)

-- Input Webhook
local whInput = GroupBox:AddInput('Webhook', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Webhook',
    Placeholder = 'Webhook Here!',
    Default     = Webhook or ""
})

-- Input Max Gems
local mgInput = GroupBox:AddInput('Max Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = 'Max Gems',
    Placeholder = 'Max Gems Here!',
    Default     = MaxGems
})

-- Input Discord ID
local diInput = GroupBox:AddInput('Discord ID', {
    Numeric     = false, 
    Finished    = false, 
    Text        = 'Discord ID',
    Placeholder = 'Discord ID Here!',
    Default     = DiscordID or ""
})

-- à¸›à¸¸à¹ˆà¸¡ Save
GroupBox:AddButton('Save Settings', function()
    LocalData.Webhook   = whInput.Value
    LocalData.MaxGems   = tonumber(mgInput.Value) or 0
    LocalData.DiscordID = diInput.Value
    LocalData.IsSended  = false  -- à¸£à¸µà¹€à¸‹à¹‡à¸•à¹ƒà¸«à¹‰à¸ªà¹ˆà¸‡à¹„à¸”à¹‰à¹ƒà¸«à¸¡à¹ˆ

    -- à¸à¸£à¸“à¸µ OldGems à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ à¹ƒà¸«à¹‰à¹€à¸‹à¹‡à¸•à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹€à¸›à¹‡à¸™ currentGem à¹€à¸¥à¸¢
    if (LocalData.OldGems or 0) == 0 then
        pcall(function()
            LocalData.OldGems = player["_stats"]["gem_amount"].Value
        end)
    end

    saveSettings(LocalData)

    -- à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸±à¸§à¹à¸›à¸£à¹ƒà¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸”à¹‰à¸§à¸¢
    Webhook   = LocalData.Webhook
    MaxGems   = LocalData.MaxGems
    DiscordID = LocalData.DiscordID
    IsSended  = LocalData.IsSended

    print("[Save] Webhook:", Webhook, "MaxGems:", MaxGems, "DiscordID:", DiscordID)
end)

print("==== Loaded New Script (Refactored) ====")
print("Settings File =>", SettingsFile)

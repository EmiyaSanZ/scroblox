-- =========================================================
-- (A) ‡∏£‡∏≠‡πÄ‡∏Å‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
-- =========================================================
if not game:IsLoaded() then
    game.Loaded:Wait()
end

repeat task.wait() until game.Players.LocalPlayer
repeat task.wait() until game.Players.LocalPlayer:FindFirstChild("PlayerGui")
repeat task.wait() until game.Players.LocalPlayer.PlayerGui:FindFirstChild("spawn_units")
repeat task.wait() until game.Players.LocalPlayer:FindFirstChild("_stats")

-- =========================================================
-- (B) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Service/‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
-- =========================================================
local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService  = game:GetService("RunService")

local player      = Players.LocalPlayer
local char        = player.Character or player.CharacterAdded:Wait()

-- ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
local SettingsFile = player.Name .. "_SHOPData.json"

-- =========================================================
-- (C) ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢
-- =========================================================
local DefaultData = {
    -- ‡∏™‡πà‡∏ß‡∏ô Settings ‡∏´‡∏•‡∏±‡∏Å
    ["WhiteScreen"] = false,

    -- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á Webhook
    ["Webhook"]     = nil,
    ["DiscordID"]   = nil,

    ["MaxGems"]     = 0,
    ["OldGems"]     = 0,
    ["IsSended"]    = false,

    -- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ...
    -- ["SomeValue"] = ...
}

-- =========================================================
-- (D) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏ã‡∏ü‡∏Ñ‡πà‡∏≤ JSON
-- =========================================================
local function loadSettings()
    if isfile and isfile(SettingsFile) then
        local content = readfile(SettingsFile)
        local success, data = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if success and type(data) == "table" then
            return data
        else
            warn("[SHOPData] JSON ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà")
        end
    end

    -- ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if writefile then
        writefile(SettingsFile, HttpService:JSONEncode(DefaultData))
    end
    return DefaultData
end

local function saveSettings(tbl)
    if writefile then
        local json = HttpService:JSONEncode(tbl)
        writefile(SettingsFile, json)
    else
        warn("[SHOPData] Executor ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö writefile => saveSettings() ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
    end
end

-- =========================================================
-- (E) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON
-- =========================================================
local LocalData   = loadSettings()

-- ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å LocalData (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DefaultData)
local WhiteScreen = LocalData.WhiteScreen or false
local Webhook     = LocalData.Webhook
local DiscordID   = LocalData.DiscordID
local MaxGems     = LocalData.MaxGems
local OldGems     = LocalData.OldGems
local IsSended    = LocalData.IsSended

-- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô nil
if OldGems == nil then OldGems = 0 end
if MaxGems == nil then MaxGems = 0 end
if IsSended == nil then IsSended = false end

-- =========================================================
-- (F) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ / ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏î‡∏¥‡∏°
-- =========================================================
local WebhookEnd = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"
local ThumbnailURL = nil

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å string
local function GetNumberFromString(S)
    return string.match(S, "%d+")
end

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Level Text
local function GetCurrentLevel(LevelText)
    if not LevelText then return "???" end
    return string.gsub(LevelText, "Level ", "")
end

-- =========================================================
-- (G) Get Thumbnail
-- =========================================================
local thumbRequest = nil
pcall(function()
    thumbRequest = syn and syn.request or request or http_request
end)

if thumbRequest then
    local ThumbnailRequest = thumbRequest({
        Url = "https://thumbnails.roblox.com/v1/users/avatar-bust?userIds="
                .. tostring(player.UserId)
                .. "&size=420x420&format=Png&isCircular=false",
        Method = "GET",
        Headers = { ["Content-Type"] = "application/json" },
    })
    if ThumbnailRequest and ThumbnailRequest.Body then
        local decode = HttpService:JSONDecode(ThumbnailRequest.Body)
        if decode and decode.data and decode.data[1] then
            ThumbnailURL = decode.data[1].imageUrl
        end
    end
end

-- ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
if ThumbnailURL == nil then
    ThumbnailURL = ""
end

print("[ThumbnailURL] =>", ThumbnailURL)

-- =========================================================
-- (H) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô/‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏°
-- =========================================================

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ Webhook ‡πÑ‡∏´‡∏°
if Webhook and WebhookEnd then
    if game.PlaceId == 8304191830 then
        -- ===================== LOBBY (8304191830) =====================
        
        -- 1) Claim Gift
        pcall(function()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_daily_reward:InvokeServer()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_christmas_calendar_reward:InvokeServer()
            game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_battlepass_rewards:InvokeServer()
        end)

        -- 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ Gems
        local currentgem = player["_stats"]["gem_amount"].Value
        if OldGems > 0 then
            if currentgem < OldGems then
                -- ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£ => ‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å MaxGems
                MaxGems = MaxGems - (OldGems - currentgem)
                if MaxGems < 0 then MaxGems = 0 end
            end
        end
        OldGems = currentgem

        -- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
        LocalData.MaxGems  = MaxGems
        LocalData.OldGems  = OldGems
        LocalData.IsSended = IsSended
        saveSettings(LocalData)

        -- 3) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á Max ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if currentgem >= MaxGems and not IsSended and MaxGems > 0 then
            IsSended = true
            LocalData.IsSended = true
            saveSettings(LocalData)

            local LevelText = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text
            local userLevel = GetCurrentLevel(LevelText)

            local descriptionend = "**ùêçùêÄùêåùêÑ :** ||%s||\n" ..
                                   "**üíé„ÉªùêÜùêÑùêåùêí : %s**\n" ..
                                   "**<a:2891bitcoin:1021469261274824764>„ÉªùêÜùêéùêãùêÉ : %s**\n" ..
                                   "**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>„ÉªùêãùêûùêØùêûùê• : %s**\n\n" ..
                                   "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤¬∑ ö‚ô°…û¬∑\n<#1009544224720568371>\n<#1021662378250752080>\n\n" ..
                                   "<a:emoji_98_jk:1054831096929452042> ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≤ <a:8699rightrainbowstar:1054740408434966588>"

            -- ‡∏™‡πà‡∏á WebhookEnd
            if thumbRequest then
                thumbRequest({
                    Url = WebhookEnd,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "<@"..tostring(DiscordID).."> <@&1006505817769521177>",
                        embeds = {{
                            title       = "**‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                            description = string.format(
                                descriptionend,
                                player.Name,
                                tostring(currentgem).." / "..tostring(MaxGems),
                                tostring(player["_stats"]["gold_amount"].Value),
                                userLevel
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { ["url"] = "" },
                            image       = { ["url"] = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end
        end

        -- 4) ‡∏™‡πà‡∏á Webhook ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        do
            local GemNow   = player["_stats"]["gem_amount"].Value
            local GoldNow  = player["_stats"]["gold_amount"].Value
            local LevelNow = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text

            -- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÉ‡∏ô description
            local description = " ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n**‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô** ‚âß‚ñΩ‚â¶ <a:3018pinkheart:1019689700224684122>\n" ..
                                "\n**Name: **||%s||\n**‡πÄ‡∏û‡∏ä‡∏£ : ** **%s <a:8865diamond:1047145579790221433>**\n" ..
                                "**‡∏ó‡∏≠‡∏á : ** **%s <a:2891bitcoin:1021469261274824764>**\n%s <a:5622bloodpotion:1047140829703180298> \n" ..
                                "‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n**EXP ‡∏à‡∏≤‡∏Å‡∏î‡πà‡∏≤‡∏ô** <:4026pridepotion:1047140826897203311>\n"

            -- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ inventory ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô original)
            local ResultValue = {
                ["Gem"]   = GemNow,
                ["gold"]  = GoldNow,
                ["Level"] = LevelNow,
            }

            -- ‡πÑ‡∏•‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô _FX_CACHE
            local fxCache = game:GetService("ReplicatedStorage")["_FX_CACHE"]
            for _, v in ipairs(fxCache:GetChildren()) do
                if v:IsA("ImageButton") then
                    -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ
                    -- (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô string ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö)
                end
            end

            -- ‡∏™‡πà‡∏á Webhook
            if thumbRequest then
                thumbRequest({
                    Url = Webhook,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "",
                        embeds = {{
                            title       = "**‚ú® PLaNS SHOP ‚ú®**",
                            description = string.format(
                                description,
                                player.Name,
                                ResultValue["Gem"].." / "..tostring(MaxGems),
                                ResultValue["gold"],
                                ResultValue["Level"]
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { url = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end

            -- ‡∏™‡πà‡∏á Webhook ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ"
            if thumbRequest then
                thumbRequest({
                    Url = Webhook,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "",
                        embeds = {{
                            title       = "**‚ú® PLaNS SHOP ‚ú®**",
                            description = "**ID: ||"..player.Name.."||**\n"..
                                          "<a:6132lightblueheartspin:1021711798203846717> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \n"..
                                          "<a:alert:1021734820461674527> ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ<a:4398qiqispin:1019693775515295824>)",
                            type        = "rich",
                            color       = tonumber(0xff0000),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { url = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end

    elseif game.PlaceId == 8349889591 then
        -- ===================== Story Mode (8349889591) =====================

        -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô => ‡πÅ‡∏à‡πâ‡∏á webhook ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°
        if thumbRequest then
            thumbRequest({
                Url = Webhook,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    content = "",
                    embeds = {{
                        title       = "**‚ú® PLaNS SHOP ‚ú®**",
                        description = "**ID: ||"..player.Name.."||**\n"..
                                      "<a:6132lightblueheartspin:1021711798203846717> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \n"..
                                      "<a:7131discordverifygreen:1019693746998218804> ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ ‚ú¶",
                        type        = "rich",
                        color       = tonumber(0x55FF66),
                        footer      = {
                            text     = "PLaNS SHOP ",
                            icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                        },
                        thumbnail   = { url = ThumbnailURL },
                        timestamp   = DateTime.now():ToIsoDate(),
                    }}
                })
            })
        end

        -- ‡πÄ‡∏ä‡πá‡∏Ñ Gems ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        local currentgem = player["_stats"]["gem_amount"].Value

        if OldGems > 0 then
            if currentgem < OldGems then
                MaxGems = MaxGems - (OldGems - currentgem)
                if MaxGems < 0 then MaxGems = 0 end
            end
        end
        OldGems = currentgem

        LocalData.MaxGems  = MaxGems
        LocalData.OldGems  = OldGems
        LocalData.IsSended = IsSended
        saveSettings(LocalData)

        -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô Max => ‡∏™‡πà‡∏á WebhookEnd
        if currentgem >= MaxGems and not IsSended and MaxGems > 0 then
            IsSended = true
            LocalData.IsSended = true
            saveSettings(LocalData)

            local LevelText = player.PlayerGui.spawn_units.Lives.Main.Desc.Level.Text
            local userLevel = GetCurrentLevel(LevelText)

            local descriptionend = "**ùêçùêÄùêåùêÑ :** ||%s||\n" ..
                                   "**üíé„ÉªùêÜùêÑùêåùêí : %s**\n" ..
                                   "**<a:2891bitcoin:1021469261274824764>„ÉªùêÜùêéùêãùêÉ : %s**\n" ..
                                   "**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>„ÉªùêãùêûùêØùêûùê• : %s**\n\n" ..
                                   "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤¬∑ ö‚ô°…û¬∑\n<#1009544224720568371>\n<#1021662378250752080>\n\n" ..
                                   "<a:emoji_98_jk:1054831096929452042> ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≤ <a:8699rightrainbowstar:1054740408434966588>"

            if thumbRequest then
                thumbRequest({
                    Url = WebhookEnd,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = HttpService:JSONEncode({
                        content = "<@"..tostring(DiscordID).."> <@&1006505817769521177>",
                        embeds = {{
                            title       = "**‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                            description = string.format(
                                descriptionend,
                                player.Name,
                                tostring(currentgem).." / "..tostring(MaxGems),
                                tostring(player["_stats"]["gold_amount"].Value),
                                userLevel
                            ),
                            type        = "rich",
                            color       = tonumber(0xFF1493),
                            footer      = {
                                text     = "PLaNS SHOP ",
                                icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                            },
                            thumbnail   = { ["url"] = "" },
                            image       = { ["url"] = ThumbnailURL },
                            timestamp   = DateTime.now():ToIsoDate(),
                        }}
                    })
                })
            end
        end

        -- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô => Workspace._DATA.GameFinished.Changed
        local wsGameFinished = game:GetService("Workspace")["_DATA"].GameFinished
        wsGameFinished.Changed:Connect(function()
            if wsGameFinished.Value == true then
                -- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô => ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏£‡∏∏‡∏õ
                local newgem = player["_stats"]["gem_amount"].Value
                if newgem < OldGems then
                    MaxGems = MaxGems - (OldGems - newgem)
                    if MaxGems < 0 then MaxGems = 0 end
                end
                OldGems = newgem

                LocalData.MaxGems  = MaxGems
                LocalData.OldGems  = OldGems
                LocalData.IsSended = IsSended
                saveSettings(LocalData)

                -- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                local PlayerGui    = player:WaitForChild("PlayerGui")
                local spawnUnits   = PlayerGui:WaitForChild("spawn_units")
                local resultsUI    = PlayerGui:WaitForChild("ResultsUI")
                local hatchInfo    = PlayerGui:WaitForChild("HatchInfo")

                local GemPath      = player["_stats"]["gem_amount"]
                local GoldPath     = player["_stats"]["gold_amount"]
                local KillsInGame  = player["_stats"].kills.Value

                local LevelText    = spawnUnits.Lives.Main.Desc.Level.Text
                local userLevel    = GetCurrentLevel(LevelText)

                local GemReward    = resultsUI.Holder.LevelRewards.ScrollingFrame.GemReward.Main.Amount.Text
                local XPReward     = resultsUI.Holder.LevelRewards.ScrollingFrame.XPReward.Main.Amount.Text
                local WaveCompleted= resultsUI.Holder.Middle.WavesCompleted.Text
                local TimeCompleted= resultsUI.Holder.Middle.Timer.Text
                local InfoGameEnd  = resultsUI.Holder.Title.Text

                local newArea      = PlayerGui:WaitForChild("NewArea")
                local MapTitle     = newArea.holder.areaTitle.Text
                local MapDesc      = newArea.holder.areaDescription.Text
                local Difficulty   = newArea.holder.Difficulty.Text

                -- ‡∏£‡∏≠ HatchInfo
                local AllItem = ""
                local buttonNext = resultsUI.Holder.Buttons.Next

                -- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î next ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ
                spawn(function()
                    while resultsUI.Holder.Visible do
                        task.wait(0.5)
                        pcall(function()
                            for _,c in pairs(getconnections(buttonNext.Activated)) do
                                c:Fire()
                            end
                        end)
                    end
                end)

                -- ‡∏î‡∏±‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° drop
                hatchInfo.holder.info1.UnitName:GetPropertyChangedSignal("Text"):Connect(function()
                    local itemName = hatchInfo.holder.info1.UnitName.Text
                    AllItem = AllItem .. ("‚óà " .. itemName .. "\n")
                end)

                local description = "üîí Username : ||%s||\n```md\n#Profile\nüíé Gems : %s\nüü° Golds : %s\nüß™ Level: %s```\n"..
                                    "```md\n#Game Infomation\n- Game : %s\n- Map : %s\n- Difficuty : %s\n- Wave : %s | %s```\n"..
                                    "```md\n#Enemies Killed\n- %d```\n"..
                                    "```md\n#Rewards:\n‚óà %s üíé\n‚óà %s üçÄ\n%s```\n"..
                                    "```‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏ß‡∏°„Éª%süíé```"

                if thumbRequest then
                    thumbRequest({
                        Url = Webhook,
                        Method = "POST",
                        Headers = { ["Content-Type"] = "application/json" },
                        Body = HttpService:JSONEncode({
                            content = "",
                            embeds = {{
                                title       = "**<:9796zerogasm:1036348241656164394> PLaNS SHOP**",
                                description = string.format(
                                    description,
                                    player.Name,
                                    GemPath.Value,
                                    GoldPath.Value,
                                    userLevel,
                                    InfoGameEnd,
                                    MapTitle .. " : " .. MapDesc,
                                    Difficulty,
                                    string.match(WaveCompleted, "%d+"), -- ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                                    TimeCompleted,
                                    KillsInGame,
                                    GemReward.." Gems",
                                    XPReward,
                                    AllItem,
                                    tostring(GemPath.Value).." / "..tostring(MaxGems)
                                ),
                                type        = "rich",
                                color       = tonumber(0x33FFCC),
                                footer      = {
                                    text     = "PLaNS SHOP ",
                                    icon_url = "https://cdn.discordapp.com/attachments/1040229055498301511/1055558443076952115/logo.png"
                                },
                                thumbnail   = { url = "" },
                                timestamp   = DateTime.now():ToIsoDate(),
                            }}
                        })
                    })
                end
            end
        end)
    end
end

-- =========================================================
-- (I) ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏î‡πâ‡∏ß‡∏¢ Lib (‡∏ó‡∏≥‡∏õ‡∏∏‡πà‡∏°/Toggle ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
-- =========================================================
local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI.lua'))()
local Window = Library:CreateWindow({
    Title    = "PLaNS SHOP",
    Center   = true, 
    AutoShow = true,
})

local Tabs    = Window:AddTab('PLaNS x SHOP')
local GroupBox= Tabs:AddLeftGroupbox('Settings')

-- Toggle White Screen (‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô LocalData.WhiteScreen)
local whitescreenToggle = GroupBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = WhiteScreen,  -- ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
})
whitescreenToggle:OnChanged(function(value)
    WhiteScreen = value
    LocalData.WhiteScreen = value
    saveSettings(LocalData)

    if value == true then
        RunService:Set3dRenderingEnabled(false)
    else
        RunService:Set3dRenderingEnabled(true)
    end
end)

-- Input Webhook
local whInput = GroupBox:AddInput('Webhook', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Webhook',
    Placeholder = 'Webhook Here!',
    Default     = Webhook or ""
})

-- Input Max Gems
local mgInput = GroupBox:AddInput('Max Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = 'Max Gems',
    Placeholder = 'Max Gems Here!',
    Default     = MaxGems
})

-- Input Discord ID
local diInput = GroupBox:AddInput('Discord ID', {
    Numeric     = false, 
    Finished    = false, 
    Text        = 'Discord ID',
    Placeholder = 'Discord ID Here!',
    Default     = DiscordID or ""
})

-- ‡∏õ‡∏∏‡πà‡∏° Save
GroupBox:AddButton('Save Settings', function()
    LocalData.Webhook   = whInput.Value
    LocalData.MaxGems   = tonumber(mgInput.Value) or 0
    LocalData.DiscordID = diInput.Value
    LocalData.IsSended  = false  -- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏´‡∏°‡πà

    -- ‡∏Å‡∏£‡∏ì‡∏µ OldGems ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô currentGem ‡πÄ‡∏•‡∏¢
    if (LocalData.OldGems or 0) == 0 then
        pcall(function()
            LocalData.OldGems = player["_stats"]["gem_amount"].Value
        end)
    end

    saveSettings(LocalData)

    -- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏î‡πâ‡∏ß‡∏¢
    Webhook   = LocalData.Webhook
    MaxGems   = LocalData.MaxGems
    DiscordID = LocalData.DiscordID
    IsSended  = LocalData.IsSended

    print("[Save] Webhook:", Webhook, "MaxGems:", MaxGems, "DiscordID:", DiscordID)
end)

print("==== Loaded New Script (Refactored) ====")
print("Settings File =>", SettingsFile)

--// new_merged_script.lua

--############################################################
-- (1) à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸·à¹‰à¸™à¸à¸²à¸™
--############################################################
if not game:IsLoaded() then
    game.Loaded:Wait()
end

if not (newWebhook:match("^https?://")) then
    warn("Webhook must start with http:// or https://")
    return
end

local Players        = game:GetService("Players")
local RunService     = game:GetService("RunService")
local HttpService    = game:GetService("HttpService")
local player         = Players.LocalPlayer

-- à¸ªà¸­à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸™à¸à¸²à¸£à¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œ
local FolderPath     = "CustomerData"
local SettingsPath   = "CustomerSettings"

-- WebhookEnd (à¸ªà¹ˆà¸‡à¹€à¸¡à¸·à¹ˆà¸­ Gems à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸²)
local WebhookEnd     = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"

-- à¸›à¸£à¸°à¸à¸²à¸¨à¸•à¸±à¸§à¹à¸›à¸£à¸—à¸µà¹ˆà¸ˆà¸°à¹ƒà¸Šà¹‰
local Webhook    = nil
local DiscordID  = nil
local MaxGems    = nil
local OldGems    = nil
local IsSended   = false
local WhiteScreen= false
local ThumbnailURL = ""

--############################################################
-- (2) à¸•à¸£à¸§à¸ˆ/à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ
--############################################################
local function SafeIsFolder(path)
    local s, r = pcall(function()
        return isfolder(path)
    end)
    return (s and r)
end

local function SafeMakeFolder(path)
    pcall(function()
        makefolder(path)
    end)
end

if not SafeIsFolder(FolderPath) then
    SafeMakeFolder(FolderPath)
end
if not SafeIsFolder(SettingsPath) then
    SafeMakeFolder(SettingsPath)
end

--############################################################
-- (3) à¸›à¸£à¸°à¸à¸²à¸¨à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œ JSON, à¹à¸¥à¸°à¹‚à¸«à¸¥à¸”/à¹€à¸‹à¸Ÿ
--############################################################
local DataFile      = FolderPath.."\\"..player.Name..".json"
local SettingsFile  = SettingsPath.."\\"..player.Name..".json"

local DefaultData   = {
    ["Webhook"]  = "https://discord.com/api/webhooks/1006516710586728572/uoA_y1vTJU5Hef6Svj7uth0f1wt4m3-gyzDrSaRREvIFxgTv1C2w6HslSEfumtlTXZKB",       -- à¸«à¸¥à¸±à¸
    ["Max Gems"] = 0,
    ["Discord ID"]= "",
    ["Old Gems"] = false,     -- à¹ƒà¸Šà¹‰ false à¹€à¸›à¹‡à¸™à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸§à¹ˆà¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸à¸³à¸«à¸™à¸”
    ["Is Sended"] = false
}

-- White Screen à¹à¸¢à¸à¹ƒà¸™ SettingsFile
local DefaultSettings = {
    ["White Screen"] = false
}

local function LoadData()
    local final = nil
    if isfile(DataFile) then
        local content = readfile(DataFile)
        local ok, decoded = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if ok and type(decoded)=="table" then
            final = decoded
        else
            warn("JSON Decode Error => Create new file:", DataFile)
        end
    end
    if not final then
        final = DefaultData
        writefile(DataFile, HttpService:JSONEncode(final))
    end
    return final
end

local function SaveData(tbl)
    writefile(DataFile, HttpService:JSONEncode(tbl))
end

local function LoadSettings()
    local final = nil
    if isfile(SettingsFile) then
        local content = readfile(SettingsFile)
        local ok, decoded = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if ok and type(decoded)=="table" then
            final = decoded
        else
            warn("JSON Decode Error => Create new file:", SettingsFile)
        end
    end
    if not final then
        final = DefaultSettings
        writefile(SettingsFile, HttpService:JSONEncode(final))
    end
    return final
end

local function SaveSettings(tbl)
    writefile(SettingsFile, HttpService:JSONEncode(tbl))
end

-- à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
local LocalData     = LoadData()
Webhook             = LocalData["Webhook"] or ""
MaxGems             = LocalData["Max Gems"] or 0
DiscordID           = LocalData["Discord ID"] or ""
OldGems             = LocalData["Old Gems"] -- à¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™ number à¸«à¸£à¸·à¸­ false
IsSended            = LocalData["Is Sended"] or false

local LocalSettings = LoadSettings()
WhiteScreen         = LocalSettings["White Screen"] or false

--############################################################
-- (4) à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢
--############################################################
local function GetNumberFromString(txt)
    return string.match(txt, "%d+")
end

--############################################################
-- (5) à¸¥à¸­à¸‡à¸‚à¸­à¸£à¸¹à¸› Thumbnail
--############################################################
pcall(function()
    local r = http.request({
        Url = "https://thumbnails.roblox.com/v1/users/avatar-bust?userIds="..tostring(player.UserId).."&size=420x420&format=Png&isCircular=false",
        Method = "GET",
        Headers = {
            ["Content-Type"] = "application/json"
        }
    })
    if r and r.Body then
        local decode = HttpService:JSONDecode(r.Body)
        ThumbnailURL = decode["data"][1]["imageUrl"] or ""
    end
    print("ThumbnailURL =", ThumbnailURL)
end)

--############################################################
-- (6) Logic Checking: PlaceId
--############################################################
local function TryGetCurrentGems()
    local gm = 0
    pcall(function()
        gm = player["_stats"]["gem_amount"].Value
    end)
    return gm
end

-- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¹ˆà¸‡ Webhook (à¸›à¸à¸•à¸´)
local function SendNormalWebhook(...)
    local requestFunc = http_request or request or HttpPost or syn and syn.request
    if not requestFunc then
        return
    end
    local title, desc = ...
    local data = {
        content = "",
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493
        }}
    }
    requestFunc({
        Url = Webhook,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

-- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Send WebhookEnd (Max Gems)
local function SendEndWebhook(...)
    local requestFunc = http_request or request or HttpPost or syn and syn.request
    if not requestFunc then
        return
    end
    local title, desc = ...
    local data = {
        content = "<@"..DiscordID.."> <@&1006505817769521177>",
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493
        }}
    }
    requestFunc({
        Url = WebhookEnd,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

-- GetCurrentLevel à¸ à¸²à¸¢à¹ƒà¸™ Lobby
local function GetCurrentLevel()
    local lvl = "???"
    pcall(function()
        local gui = player.PlayerGui["spawn_units"]
        local str = gui.Lives.Main.Desc.Level.Text
        lvl = string.gsub(str, "Level ", "")
    end)
    return lvl
end

-- Checking
local currentPlace = game.PlaceId
local currentGems = TryGetCurrentGems()

if Webhook and WebhookEnd then
    if currentPlace == 8304191830 then
        -- ---------- LOBBY -----------
        -- Claim Gift
        --pcall(function()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_daily_reward:InvokeServer()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_christmas_calendar_reward:InvokeServer()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_battlepass_rewards:InvokeServer()
        --end)

        -- à¹€à¸Šà¹‡à¸„ Gems
        if OldGems ~= nil and OldGems ~= false then
            if currentGems < OldGems then
                -- à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸Šà¹‰à¹€à¸à¸Šà¸£
                local diff = (tonumber(GetNumberFromString(tostring(OldGems))) or 0) - (tonumber(GetNumberFromString(tostring(currentGems))) or 0)
                MaxGems = MaxGems - diff
                -- save
                LocalData["Max Gems"] = MaxGems
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            else
                -- à¹€à¸à¸Šà¸£à¹€à¸à¸´à¹ˆà¸¡ à¸«à¸£à¸·à¸­à¹€à¸—à¹ˆà¸²à¹€à¸”à¸´à¸¡
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            end
        else
            -- à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸¡à¸µ OldGems
            LocalData["Old Gems"] = currentGems
            SaveData(LocalData)
        end

        -- à¸–à¹‰à¸² Gems à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸² => à¸ªà¹ˆà¸‡ WebhookEnd
        if (currentGems >= (tonumber(GetNumberFromString(tostring(MaxGems))) or 0)) and (IsSended == false) then
            IsSended = true
            LocalData["Is Sended"] = true
            SaveData(LocalData)

            local lv = GetCurrentLevel()
            local descEnd = "**ğğ€ğŒğ„ :** ||%s||\n**ğŸ’ãƒ»ğ†ğ„ğŒğ’ : %s**\n**<a:2891bitcoin:1021469261274824764>ãƒ»ğ†ğğ‹ğƒ : %s**\n**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>ãƒ»ğ‹ğğ¯ğğ¥ : %s**\n\nà¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸£à¸µà¸§à¸´à¸§à¸”à¹‰à¸§à¸¢à¸™à¹‰à¸²Â·Êšâ™¡ÉÂ·\n<#1009544224720568371>\n<#1021662378250752080>\n\n<a:emoji_98_jk:1054831096929452042> à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£à¸™à¹‰à¸² <a:8699rightrainbowstar:1054740408434966588>"
            SendEndWebhook(
                "**à¸Ÿà¸²à¸¡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¹„à¸”à¹‰à¹€à¸¥à¸¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                string.format(
                    descEnd,
                    player.Name,
                    tostring(currentGems).." / "..tostring(MaxGems),
                    tostring(player["_stats"]["gold_amount"].Value),
                    lv
                )
            )
        end

        -- à¸ªà¹ˆà¸‡à¸›à¸à¸•à¸´
        local normalDesc = "**ID: ||"..player.Name.."||**\n<a:6132lightblueheartspin:1021711798203846717> à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸ªà¸–à¸²à¸™à¸° \n<a:alert:1021734820461674527> à¹€à¸¥à¹ˆà¸™à¸ˆà¸šà¹à¸¥à¹‰à¸§à¸•à¸­à¸™à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸¥à¹‡à¸­à¸šà¸šà¸µà¹‰"
        SendNormalWebhook("**âœ¨ PLaNS SHOP âœ¨**", normalDesc)

    elseif currentPlace == 8349889591 then
        -- ---------- INGAME -----------
        -- à¸–à¹‰à¸² gems à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸² => isSended = true + webhook
        if (currentGems >= (tonumber(GetNumberFromString(tostring(MaxGems))) or 0)) and (IsSended==false) then
            IsSended = true
            LocalData["Is Sended"] = true
            SaveData(LocalData)
            local lv = GetCurrentLevel()
            local descEnd = "**ğğ€ğŒğ„ :** ||%s||\n**ğŸ’ãƒ»ğ†ğ„ğŒğ’ : %s**\n**<a:2891bitcoin:1021469261274824764>ãƒ»ğ†ğğ‹ğƒ : %s**\n**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>ãƒ»ğ‹ğğ¯ğğ¥ : %s**\n\nà¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸£à¸µà¸§à¸´à¸§à¸”à¹‰à¸§à¸¢à¸™à¹‰à¸²Â·Êšâ™¡ÉÂ·"
            SendEndWebhook(
                "**à¸Ÿà¸²à¸¡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¹„à¸”à¹‰à¹€à¸¥à¸¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                string.format(
                    descEnd,
                    player.Name,
                    tostring(currentGems).." / "..tostring(MaxGems),
                    tostring(player["_stats"]["gold_amount"].Value),
                    lv
                )
            )
        end

        -- à¸ªà¹ˆà¸‡à¸›à¸à¸•à¸´
        local normalDesc = "**ID: ||"..player.Name.."||**\n<a:6132lightblueheartspin:1021711798203846717> à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸ªà¸–à¸²à¸™à¸° \n<a:7131discordverifygreen:1019693746998218804> à¸•à¸­à¸™à¸™à¸µà¹‰à¸à¸³à¸¥à¸±à¸‡à¸Ÿà¸²à¸¡à¹à¸¥à¹‰à¸§à¸™à¸° âœ¦"
        SendNormalWebhook("**âœ¨ PLaNS SHOP âœ¨**", normalDesc)

        -- à¹€à¸Šà¹‡à¸„ Gems
        if OldGems ~= nil and OldGems ~= false then
            if currentGems < OldGems then
                local diff = (tonumber(GetNumberFromString(tostring(OldGems))) or 0) - (tonumber(GetNumberFromString(tostring(currentGems))) or 0)
                MaxGems = MaxGems - diff
                LocalData["Max Gems"] = MaxGems
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            else
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            end
        else
            LocalData["Old Gems"] = currentGems
            SaveData(LocalData)
        end

        -- à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸ªà¸£à¸´à¸¡: à¹€à¸¡à¸·à¹ˆà¸­à¸ˆà¸šà¹€à¸à¸¡ => à¸—à¸³à¸­à¸°à¹„à¸£
        local GF = workspace:WaitForChild("_DATA"):WaitForChild("GameFinished")
        GF.Changed:Connect(function()
            if GF.Value == true then
                -- Logic à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¸ˆà¸°à¹€à¸‚à¸µà¸¢à¸™ Hook à¸ªà¸£à¹‰à¸²à¸‡ Request à¹€à¸à¸·à¹ˆà¸­à¸ªà¹ˆà¸‡ Webhook à¹„à¸”à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
                -- (à¹€à¸«à¸¡à¸·à¸­à¸™à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹ƒà¸™à¹‚à¸„à¹‰à¸”à¹€à¸”à¸´à¸¡)
                print("GameFinished => Send something?")
            end
        end)
    end
end

--############################################################
-- (7) à¸ªà¸£à¹‰à¸²à¸‡ UI
--############################################################
local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI'))()
local Window = Library:CreateWindow({
    Title = "PLaNS x SHOP",
    Center = true, 
    AutoShow = true,
})

local MainTab = Window:AddTab("PLaNS x SHOP")
local SettingsBox = MainTab:AddLeftGroupbox("Settings")

-- Toggle White Screen
local whitescreen = SettingsBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = WhiteScreen,
})
whitescreen:OnChanged(function(val)
    WhiteScreen = val
    LocalSettings["White Screen"] = val
    SaveSettings(LocalSettings)
    if val then
        RunService:Set3dRenderingEnabled(false)
    else
        RunService:Set3dRenderingEnabled(true)
    end
end)

-- Input Webhook
local wh = SettingsBox:AddInput('Webhook', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Webhook',
    Placeholder = 'Webhook Here!',
    Default     = Webhook
})

-- Input Max Gems
local mg = SettingsBox:AddInput('Max Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = 'Max Gems',
    Placeholder = 'Max Gems Here!'
})
if MaxGems then
    mg:SetValue(tostring(MaxGems))
end

-- Input Discord ID
local di = SettingsBox:AddInput('Discord ID', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Discord ID',
    Placeholder = 'Discord ID Here!'
})
if DiscordID then
    di:SetValue(tostring(DiscordID))
end

-- à¸›à¸¸à¹ˆà¸¡ Save
SettingsBox:AddButton('Save Settings', function()
    local newWebhook = wh.Value or ""
    -- à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸² newWebhook à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ http
    local prefix = string.sub(newWebhook, 1, 4):lower()
    if prefix ~= "http" then
        warn("Webhook must start with https:// or http://")
        return
    end

    local data = LoadData()
    data["Max Gems"]   = tonumber(mg.Value) or 0
    data["Webhook"]    = newWebhook
    data["Discord ID"] = di.Value
    data["Is Sended"]  = false

    if not data["Old Gems"] then
        data["Old Gems"] = 0
    end
    SaveData(data)

    Webhook   = data["Webhook"]
    MaxGems   = data["Max Gems"]
    DiscordID = data["Discord ID"]
    IsSended  = false

    print("Saved => Webhook="..Webhook..", MaxGems="..MaxGems..", DiscordID="..DiscordID)
end)


print("Merged script loaded successfully!")

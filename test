--// new_merged_script.lua

--############################################################
-- (1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
--############################################################
if not game:IsLoaded() then
    game.Loaded:Wait()
end

if not (newWebhook:match("^https?://")) then
    warn("Webhook must start with http:// or https://")
    return
end

local Players        = game:GetService("Players")
local RunService     = game:GetService("RunService")
local HttpService    = game:GetService("HttpService")
local player         = Players.LocalPlayer

-- ‡∏™‡∏≠‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå
local FolderPath     = "CustomerData"
local SettingsPath   = "CustomerSettings"

-- WebhookEnd (‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ Gems ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤)
local WebhookEnd     = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"

-- ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ
local Webhook    = nil
local DiscordID  = nil
local MaxGems    = nil
local OldGems    = nil
local IsSended   = false
local WhiteScreen= false
local ThumbnailURL = ""

--############################################################
-- (2) ‡∏ï‡∏£‡∏ß‡∏à/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
--############################################################
local function SafeIsFolder(path)
    local s, r = pcall(function()
        return isfolder(path)
    end)
    return (s and r)
end

local function SafeMakeFolder(path)
    pcall(function()
        makefolder(path)
    end)
end

if not SafeIsFolder(FolderPath) then
    SafeMakeFolder(FolderPath)
end
if not SafeIsFolder(SettingsPath) then
    SafeMakeFolder(SettingsPath)
end

--############################################################
-- (3) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå JSON, ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏ã‡∏ü
--############################################################
local DataFile      = FolderPath.."\\"..player.Name..".json"
local SettingsFile  = SettingsPath.."\\"..player.Name..".json"

local DefaultData   = {
    ["Webhook"]  = "https://discord.com/api/webhooks/1006516710586728572/uoA_y1vTJU5Hef6Svj7uth0f1wt4m3-gyzDrSaRREvIFxgTv1C2w6HslSEfumtlTXZKB",       -- ‡∏´‡∏•‡∏±‡∏Å
    ["Max Gems"] = 0,
    ["Discord ID"]= "",
    ["Old Gems"] = false,     -- ‡πÉ‡∏ä‡πâ false ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î
    ["Is Sended"] = false
}

-- White Screen ‡πÅ‡∏¢‡∏Å‡πÉ‡∏ô SettingsFile
local DefaultSettings = {
    ["White Screen"] = false
}

local function LoadData()
    local final = nil
    if isfile(DataFile) then
        local content = readfile(DataFile)
        local ok, decoded = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if ok and type(decoded)=="table" then
            final = decoded
        else
            warn("JSON Decode Error => Create new file:", DataFile)
        end
    end
    if not final then
        final = DefaultData
        writefile(DataFile, HttpService:JSONEncode(final))
    end
    return final
end

local function SaveData(tbl)
    writefile(DataFile, HttpService:JSONEncode(tbl))
end

local function LoadSettings()
    local final = nil
    if isfile(SettingsFile) then
        local content = readfile(SettingsFile)
        local ok, decoded = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if ok and type(decoded)=="table" then
            final = decoded
        else
            warn("JSON Decode Error => Create new file:", SettingsFile)
        end
    end
    if not final then
        final = DefaultSettings
        writefile(SettingsFile, HttpService:JSONEncode(final))
    end
    return final
end

local function SaveSettings(tbl)
    writefile(SettingsFile, HttpService:JSONEncode(tbl))
end

-- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
local LocalData     = LoadData()
Webhook             = LocalData["Webhook"] or ""
MaxGems             = LocalData["Max Gems"] or 0
DiscordID           = LocalData["Discord ID"] or ""
OldGems             = LocalData["Old Gems"] -- ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô number ‡∏´‡∏£‡∏∑‡∏≠ false
IsSended            = LocalData["Is Sended"] or false

local LocalSettings = LoadSettings()
WhiteScreen         = LocalSettings["White Screen"] or false

--############################################################
-- (4) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢
--############################################################
local function GetNumberFromString(txt)
    return string.match(txt, "%d+")
end

--############################################################
-- (5) ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏£‡∏π‡∏õ Thumbnail
--############################################################
pcall(function()
    local r = http.request({
        Url = "https://thumbnails.roblox.com/v1/users/avatar-bust?userIds="..tostring(player.UserId).."&size=420x420&format=Png&isCircular=false",
        Method = "GET",
        Headers = {
            ["Content-Type"] = "application/json"
        }
    })
    if r and r.Body then
        local decode = HttpService:JSONDecode(r.Body)
        ThumbnailURL = decode["data"][1]["imageUrl"] or ""
    end
    print("ThumbnailURL =", ThumbnailURL)
end)

--############################################################
-- (6) Logic Checking: PlaceId
--############################################################
local function TryGetCurrentGems()
    local gm = 0
    pcall(function()
        gm = player["_stats"]["gem_amount"].Value
    end)
    return gm
end

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Webhook (‡∏õ‡∏Å‡∏ï‡∏¥)
local function SendNormalWebhook(...)
    local requestFunc = http_request or request or HttpPost or syn and syn.request
    if not requestFunc then
        return
    end
    local title, desc = ...
    local data = {
        content = "",
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493
        }}
    }
    requestFunc({
        Url = Webhook,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Send WebhookEnd (Max Gems)
local function SendEndWebhook(...)
    local requestFunc = http_request or request or HttpPost or syn and syn.request
    if not requestFunc then
        return
    end
    local title, desc = ...
    local data = {
        content = "<@"..DiscordID.."> <@&1006505817769521177>",
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493
        }}
    }
    requestFunc({
        Url = WebhookEnd,
        Method = "POST",
        Headers = {["Content-Type"]="application/json"},
        Body = HttpService:JSONEncode(data)
    })
end

-- GetCurrentLevel ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Lobby
local function GetCurrentLevel()
    local lvl = "???"
    pcall(function()
        local gui = player.PlayerGui["spawn_units"]
        local str = gui.Lives.Main.Desc.Level.Text
        lvl = string.gsub(str, "Level ", "")
    end)
    return lvl
end

-- Checking
local currentPlace = game.PlaceId
local currentGems = TryGetCurrentGems()

if Webhook and WebhookEnd then
    if currentPlace == 8304191830 then
        -- ---------- LOBBY -----------
        -- Claim Gift
        --pcall(function()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_daily_reward:InvokeServer()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_christmas_calendar_reward:InvokeServer()
        --    game:GetService("ReplicatedStorage").endpoints.client_to_server.claim_battlepass_rewards:InvokeServer()
        --end)

        -- ‡πÄ‡∏ä‡πá‡∏Ñ Gems
        if OldGems ~= nil and OldGems ~= false then
            if currentGems < OldGems then
                -- ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£
                local diff = (tonumber(GetNumberFromString(tostring(OldGems))) or 0) - (tonumber(GetNumberFromString(tostring(currentGems))) or 0)
                MaxGems = MaxGems - diff
                -- save
                LocalData["Max Gems"] = MaxGems
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            else
                -- ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            end
        else
            -- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ OldGems
            LocalData["Old Gems"] = currentGems
            SaveData(LocalData)
        end

        -- ‡∏ñ‡πâ‡∏≤ Gems ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ => ‡∏™‡πà‡∏á WebhookEnd
        if (currentGems >= (tonumber(GetNumberFromString(tostring(MaxGems))) or 0)) and (IsSended == false) then
            IsSended = true
            LocalData["Is Sended"] = true
            SaveData(LocalData)

            local lv = GetCurrentLevel()
            local descEnd = "**ùêçùêÄùêåùêÑ :** ||%s||\n**üíé„ÉªùêÜùêÑùêåùêí : %s**\n**<a:2891bitcoin:1021469261274824764>„ÉªùêÜùêéùêãùêÉ : %s**\n**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>„ÉªùêãùêûùêØùêûùê• : %s**\n\n‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤¬∑ ö‚ô°…û¬∑\n<#1009544224720568371>\n<#1021662378250752080>\n\n<a:emoji_98_jk:1054831096929452042> ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≤ <a:8699rightrainbowstar:1054740408434966588>"
            SendEndWebhook(
                "**‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                string.format(
                    descEnd,
                    player.Name,
                    tostring(currentGems).." / "..tostring(MaxGems),
                    tostring(player["_stats"]["gold_amount"].Value),
                    lv
                )
            )
        end

        -- ‡∏™‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
        local normalDesc = "**ID: ||"..player.Name.."||**\n<a:6132lightblueheartspin:1021711798203846717> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \n<a:alert:1021734820461674527> ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ"
        SendNormalWebhook("**‚ú® PLaNS SHOP ‚ú®**", normalDesc)

    elseif currentPlace == 8349889591 then
        -- ---------- INGAME -----------
        -- ‡∏ñ‡πâ‡∏≤ gems ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ => isSended = true + webhook
        if (currentGems >= (tonumber(GetNumberFromString(tostring(MaxGems))) or 0)) and (IsSended==false) then
            IsSended = true
            LocalData["Is Sended"] = true
            SaveData(LocalData)
            local lv = GetCurrentLevel()
            local descEnd = "**ùêçùêÄùêåùêÑ :** ||%s||\n**üíé„ÉªùêÜùêÑùêåùêí : %s**\n**<a:2891bitcoin:1021469261274824764>„ÉªùêÜùêéùêãùêÉ : %s**\n**<a:3729_Little_Pretty_Star_Pink:1054740345709146182>„ÉªùêãùêûùêØùêûùê• : %s**\n\n‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤¬∑ ö‚ô°…û¬∑"
            SendEndWebhook(
                "**‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! <a:6157gawrgurapopcorn:1019689697590648973>**",
                string.format(
                    descEnd,
                    player.Name,
                    tostring(currentGems).." / "..tostring(MaxGems),
                    tostring(player["_stats"]["gold_amount"].Value),
                    lv
                )
            )
        end

        -- ‡∏™‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
        local normalDesc = "**ID: ||"..player.Name.."||**\n<a:6132lightblueheartspin:1021711798203846717> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \n<a:7131discordverifygreen:1019693746998218804> ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ ‚ú¶"
        SendNormalWebhook("**‚ú® PLaNS SHOP ‚ú®**", normalDesc)

        -- ‡πÄ‡∏ä‡πá‡∏Ñ Gems
        if OldGems ~= nil and OldGems ~= false then
            if currentGems < OldGems then
                local diff = (tonumber(GetNumberFromString(tostring(OldGems))) or 0) - (tonumber(GetNumberFromString(tostring(currentGems))) or 0)
                MaxGems = MaxGems - diff
                LocalData["Max Gems"] = MaxGems
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            else
                LocalData["Old Gems"] = currentGems
                SaveData(LocalData)
            end
        else
            LocalData["Old Gems"] = currentGems
            SaveData(LocalData)
        end

        -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏° => ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
        local GF = workspace:WaitForChild("_DATA"):WaitForChild("GameFinished")
        GF.Changed:Connect(function()
            if GF.Value == true then
                -- Logic ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Hook ‡∏™‡∏£‡πâ‡∏≤‡∏á Request ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á Webhook ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                -- (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
                print("GameFinished => Send something?")
            end
        end)
    end
end

--############################################################
-- (7) ‡∏™‡∏£‡πâ‡∏≤‡∏á UI
--############################################################
local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI'))()
local Window = Library:CreateWindow({
    Title = "PLaNS x SHOP",
    Center = true, 
    AutoShow = true,
})

local MainTab = Window:AddTab("PLaNS x SHOP")
local SettingsBox = MainTab:AddLeftGroupbox("Settings")

-- Toggle White Screen
local whitescreen = SettingsBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = WhiteScreen,
})
whitescreen:OnChanged(function(val)
    WhiteScreen = val
    LocalSettings["White Screen"] = val
    SaveSettings(LocalSettings)
    if val then
        RunService:Set3dRenderingEnabled(false)
    else
        RunService:Set3dRenderingEnabled(true)
    end
end)

-- Input Webhook
local wh = SettingsBox:AddInput('Webhook', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Webhook',
    Placeholder = 'Webhook Here!',
    Default     = Webhook
})

-- Input Max Gems
local mg = SettingsBox:AddInput('Max Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = 'Max Gems',
    Placeholder = 'Max Gems Here!'
})
if MaxGems then
    mg:SetValue(tostring(MaxGems))
end

-- Input Discord ID
local di = SettingsBox:AddInput('Discord ID', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Discord ID',
    Placeholder = 'Discord ID Here!'
})
if DiscordID then
    di:SetValue(tostring(DiscordID))
end

-- ‡∏õ‡∏∏‡πà‡∏° Save
SettingsBox:AddButton('Save Settings', function()
    local newWebhook = wh.Value or ""
    -- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ newWebhook ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ http
    local prefix = string.sub(newWebhook, 1, 4):lower()
    if prefix ~= "http" then
        warn("Webhook must start with https:// or http://")
        return
    end

    local data = LoadData()
    data["Max Gems"]   = tonumber(mg.Value) or 0
    data["Webhook"]    = newWebhook
    data["Discord ID"] = di.Value
    data["Is Sended"]  = false

    if not data["Old Gems"] then
        data["Old Gems"] = 0
    end
    SaveData(data)

    Webhook   = data["Webhook"]
    MaxGems   = data["Max Gems"]
    DiscordID = data["Discord ID"]
    IsSended  = false

    print("Saved => Webhook="..Webhook..", MaxGems="..MaxGems..", DiscordID="..DiscordID)
end)


print("Merged script loaded successfully!")

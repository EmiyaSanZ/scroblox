--// final_script_immediate_webhook_ui_plus_addgems.lua

--------------------------------------------------------------------------------
-- (A) ‡∏™‡πà‡∏á Webhook ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏£‡∏±‡∏ô (Player, Gems, ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)
--------------------------------------------------------------------------------

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players    = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService= game:GetService("HttpService")
local player     = Players.LocalPlayer

-- Webhook ‡∏´‡∏•‡∏±‡∏Å + WebhookEnd
_G.Webhook   = "https://discord.com/api/webhooks/1006516710586728572/uoA_y1vTJU5Hef6Svj7uth0f1wt4m3-gyzDrSaRREvIFxgTv1C2w6HslSEfumtlTXZKB"
local WebhookEnd = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"

--------------------------------------------------------------------------------
-- (A0) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)
--------------------------------------------------------------------------------

local SettingsPath = "PLaNSxSHOP"        -- ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå
if not isfolder or not writefile then
    warn("Executor ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö isfolder/makefolder ‡∏´‡∏£‡∏∑‡∏≠ writefile => ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
end

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
if isfolder and not isfolder(SettingsPath) then
    makefolder(SettingsPath)
end

-- ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô + .json
local SettingsFile = SettingsPath.."\\"..player.Name..".json"

--------------------------------------------------------------------------------
-- (A1) ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå)
--------------------------------------------------------------------------------
local DefaultData = {
    -- ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ MaxGems ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏£‡∏á ‡πÜ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ "MaxGems ‡∏£‡∏ß‡∏°" ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    MaxGems        = 0,
    DiscordID      = "",
    OldGems        = 0,
    IsSended       = false,
    -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥ ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‚Äù
    AddGemsWanted  = 0
}

--------------------------------------------------------------------------------
-- (B) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON
--------------------------------------------------------------------------------
local function loadSettings()
    -- ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô isfile, readfile ‡πÑ‡∏´‡∏°
    if isfile and isfile(SettingsFile) then
        local s = readfile(SettingsFile)
        local ok, data = pcall(function()
            return HttpService:JSONDecode(s)
        end)
        if ok and type(data)=="table" then
            return data
        else
            warn("‡πÑ‡∏ü‡∏•‡πå JSON ‡∏û‡∏±‡∏á => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà: "..SettingsFile)
        end
    end
    if writefile then
        writefile(SettingsFile, HttpService:JSONEncode(DefaultData))
    end
    return DefaultData
end

local function saveSettings(tbl)
    if writefile then
        local s = HttpService:JSONEncode(tbl)
        writefile(SettingsFile, s)
    else
        warn("Executor ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö writefile => saveSettings ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
    end
end

--------------------------------------------------------------------------------
-- (C) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON + ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Gems ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
--------------------------------------------------------------------------------

local LocalData = loadSettings()

local MaxGems       = LocalData.MaxGems        or 0  -- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏°
local DiscordID     = LocalData.DiscordID      or ""
local OldGems       = LocalData.OldGems        or 0
local IsSended      = LocalData.IsSended       or false
local AddGemsWanted = LocalData.AddGemsWanted  or 0  -- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°

local stats = player:WaitForChild("_stats", 30)
local gemObj = stats and stats:WaitForChild("gem_amount", 30)

local currentGems = 0
if gemObj and typeof(gemObj.Value)=="number" then
    currentGems = gemObj.Value
else
    warn("‡πÑ‡∏°‡πà‡∏û‡∏ö gem_amount => currentGems=0")
end

--------------------------------------------------------------------------------
-- (D) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Webhook / WebhookEnd
--------------------------------------------------------------------------------
local function sendWebhook(title, desc)
    local req = http_request or request or HttpPost or syn and syn.request
    if not req then
        warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => ‡∏™‡πà‡∏á Webhook ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
        return
    end
    local payload = {
        content = "",
        embeds = {
            {
                title = title,
                description = desc,
                color = 0x00FF99
            }
        }
    }
    req({
        Url     = _G.Webhook,
        Method  = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body    = HttpService:JSONEncode(payload)
    })
end

local function sendWebhookEnd(title, desc)
    local req = http_request or request or HttpPost or syn and syn.request
    if not req then
        warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => WebhookEnd ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
        return
    end
    local payload = {
        content = "<@"..DiscordID..">", -- mention
        embeds = {
            {
                title = title,
                description = desc,
                color = 0xFF1493
            }
        }
    }
    req({
        Url     = WebhookEnd,
        Method  = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body    = HttpService:JSONEncode(payload)
    })
end

--------------------------------------------------------------------------------
-- (E) ‡∏™‡πà‡∏á Webhook ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
--------------------------------------------------------------------------------

sendWebhook(
    "PLaNS x ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏ä‡∏£",
    string.format(
        "ùêçùêÄùêåùêÑ : ||**%s**||\n" ..
        "‡πÄ‡∏û‡∏ä‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ : **%d** <a:8865diamond:1047145579790221433>\n" ..
        "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ : **%d** <a:8865diamond:1047145579790221433>\n" ..
        "‡∏¢‡∏≠‡∏î‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **%d**" ,
        player.Name,
        currentGems,
        MaxGems,
        AddGemsWanted    -- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°)
    )
)

-- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£ => ‡∏´‡∏±‡∏Å MaxGems
if currentGems < OldGems then
    local diff = OldGems - currentGems
    LocalData.MaxGems = math.max(LocalData.MaxGems - diff, 0)
    print(string.format("‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£ %d => MaxGems = %d", diff, LocalData.MaxGems))
elseif currentGems > OldGems then
    print(string.format("‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° %d => OldGems: %d -> %d", currentGems - OldGems, OldGems, currentGems))
end

LocalData.OldGems = currentGems

if currentGems >= LocalData.MaxGems
   and LocalData.MaxGems > 0
   and (not LocalData.IsSended) then

    sendWebhookEnd(
        "- ‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤ <a:9828pinkpixelheart:1021714314446508082>",
        string.format("‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô **%s** \n ‡∏°‡∏µ %d / %d ‡πÄ‡∏û‡∏ä‡∏£‡πÅ‡∏•‡πâ‡∏ß <a:8865diamond:1047145579790221433> \n- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!", 
            player.Name, currentGems, LocalData.MaxGems
        )
    )
    LocalData.IsSended = true
end

saveSettings(LocalData)

--------------------------------------------------------------------------------
-- (F) ‡∏™‡∏£‡πâ‡∏≤‡∏á UI (Lib): ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å ‚ÄúAdd Gems‚Äù (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡πÅ‡∏ó‡∏ô MaxGems
--------------------------------------------------------------------------------

local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI'))()
local Window  = Library:CreateWindow({
    Title    = "PLaNS x SHOP",
    Center   = true,
    AutoShow = true,
})

local MainTab     = Window:AddTab("PLaNS x SHOP")
local SettingsBox = MainTab:AddLeftGroupbox("Settings")

-- ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏™‡πà ‚Äú‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏µ‡πà‡πÄ‡∏û‡∏ä‡∏£‚Äù (AddGemsWanted)
local addGemsInput = SettingsBox:AddInput('Add Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏µ‡πà‡πÄ‡∏û‡∏ä‡∏£?',
    Placeholder = '‡πÄ‡∏ä‡πà‡∏ô 200, 20000 ‡∏Ø‡∏•‡∏Ø',
    Default     = LocalData.AddGemsWanted or 0
})

local di = SettingsBox:AddInput('Discord ID', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Discord ID',
    Placeholder = '‡πÉ‡∏™‡πà Discord ID',
    Default     = LocalData.DiscordID
})

SettingsBox:AddButton('Save Settings', function()
    local addGemsNum = tonumber(addGemsInput.Value) or 0

    -- MaxGems = currentGems + addGemsNum
    LocalData.MaxGems       = currentGems + math.max(addGemsNum, 0)
    LocalData.DiscordID     = di.Value
    LocalData.AddGemsWanted = addGemsNum -- ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÇ‡∏ä‡∏ß‡πå/Debug
    LocalData.IsSended      = false

    if typeof(LocalData.OldGems) ~= "number" then
        LocalData.OldGems = 0
    end
    if LocalData.OldGems == 0 then
        LocalData.OldGems = currentGems
    end

    saveSettings(LocalData)

    print(string.format(
        "[SaveSettings] AddGemsWanted=%d => MaxGems=%d (current=%d), DiscordID=%s",
        addGemsNum, LocalData.MaxGems, currentGems, LocalData.DiscordID
    ))
end)

-- ‡∏õ‡∏∏‡πà‡∏° Test Webhook
SettingsBox:AddButton('Test Webhook', function()
    local testDesc = string.format(
        "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡πÄ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!\n‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: %s\n‡πÄ‡∏û‡∏ä‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: %d\n‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: %d\n(‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°: %d)",
        player.Name,
        currentGems,
        LocalData.MaxGems,
        LocalData.AddGemsWanted
    )
    sendWebhook("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÜ", testDesc)
end)

SettingsBox:AddLabel("Optional UI Toggles"):AddTooltip("‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πá‡∏•‡∏ö‡πÑ‡∏î‡πâ")
local WhiteScreenToggle = SettingsBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = false,
})
WhiteScreenToggle:OnChanged(function(value)
    RunService:Set3dRenderingEnabled(not value)
end)

print("Script loaded (unique file per player). Add Gems => MaxGems = current + addGemsNum, UI ok!")

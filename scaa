--// final_script_immediate_webhook_ui_plus_addgems.lua
repeat wait() until game.Players.LocalPlayer and game.Players.LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("spawn_units")
repeat wait() until game.Players.LocalPlayer:FindFirstChild("_stats")
--------------------------------------------------------------------------------
-- (A) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
--------------------------------------------------------------------------------

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players    = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService= game:GetService("HttpService")
local player     = Players.LocalPlayer
local ThumbnailURL = nil

local ThumbnailRequest = http.request(
    {
        Url = "https://thumbnails.roblox.com/v1/users/avatar?userIds="..tostring(game.Players.LocalPlayer.UserId).."&size=420x420&format=Png&isCircular=false",
        Method = "GET",
        Headers = {
            ["Content-Type"] = "application/json"
        },
    }
)
ThumbnailURL = (game:GetService("HttpService"):JSONDecode(ThumbnailRequest.Body))["data"][1]["imageUrl"]
print(ThumbnailURL)


--------------------------------------------------------------------------------
-- (B) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Webhook ‡∏´‡∏•‡∏±‡∏Å + WebhookEnd
--------------------------------------------------------------------------------

_G.Webhook    = "https://discord.com/api/webhooks/1283623950017892382/2y8Qax0xHlH-UYlDulC9-2GCsG_qjIqswU6rt-q9fGR3ix9o7SfDGXR-9lL6PqB64jbb"
_G.Webhook2    = "https://discord.com/api/webhooks/1006516710586728572/uoA_y1vTJU5Hef6Svj7uth0f1wt4m3-gyzDrSaRREvIFxgTv1C2w6HslSEfumtlTXZKB"
local WebhookEnd = "https://discord.com/api/webhooks/1099711689450066060/_0cDSkNN4gfosy0oL-5i9Rg8BXF0hQ2Bu4d3H-AlCuZf1T8_3hL-qxi3X1mt1DrDtLcV"

--------------------------------------------------------------------------------
-- (C) ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå JSON = "<PlayerName>_SHOPData.json"
--------------------------------------------------------------------------------

local SettingsFile = player.Name .. "_SHOPData.json"

-- ‡∏Ñ‡πà‡∏≤ Default ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå
local DefaultData = {
    MaxGems       = 0,
    DiscordID     = "",
    OldGems       = 0,
    IsSended      = false,
    AddGemsWanted = 0,

    SavedLevel    = "???",  -- <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (default ???)
    SavedBP       = "???",   -- <<-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ BP ‡πÉ‡∏´‡∏°‡πà
    SavedBP2       = "???"
}

--------------------------------------------------------------------------------
-- (D) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô load/save ‡πÑ‡∏ü‡∏•‡πå JSON
--------------------------------------------------------------------------------

local function loadSettings()
    if isfile and isfile(SettingsFile) then
        local content = readfile(SettingsFile)
        local success, data = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        if success and type(data)=="table" then
            return data
        else
            warn("‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏™‡∏µ‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà: " .. SettingsFile)
        end
    end
    -- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠ decode ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô => ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if writefile then
        writefile(SettingsFile, HttpService:JSONEncode(DefaultData))
    else
        warn("Executor ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö writefile => loadSettings ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
    end
    return DefaultData
end

local function saveSettings(tbl)
    if writefile then
        local s = HttpService:JSONEncode(tbl)
        writefile(SettingsFile, s)
    else
        warn("Executor ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö writefile => saveSettings ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
    end
end

--------------------------------------------------------------------------------
-- (E) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå + ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤
--------------------------------------------------------------------------------

local LocalData = loadSettings()

local MaxGems       = LocalData.MaxGems or 0
local DiscordID     = LocalData.DiscordID or ""
local OldGems       = LocalData.OldGems or 0
local IsSended      = LocalData.IsSended or false
local AddGemsWanted = LocalData.AddGemsWanted or 0
local SavedLevel    = LocalData.SavedLevel or "???"
local SavedBP       = LocalData.SavedBP or "???"
local SavedBP2       = LocalData.SavedBP2 or "???"

--------------------------------------------------------------------------------
-- (F) ‡∏•‡∏≠‡∏á‡∏´‡∏≤ _stats.gem_amount (‡∏Å‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å)
--------------------------------------------------------------------------------

local gemObj
local currentGems = 0
pcall(function()
    local stats = player:WaitForChild("_stats", 5)
    gemObj = stats and stats:WaitForChild("gem_amount", 2)
end)
if gemObj and typeof(gemObj.Value)=="number" then
    currentGems = gemObj.Value
else
    warn("‡πÑ‡∏°‡πà‡∏û‡∏ö gem_amount => currentGems=0")
end



-- ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î gold_amount ‡πÅ‡∏ö‡∏ö pcall ‡∏Å‡∏±‡∏ô error
local stats = player:WaitForChild("_stats", 5)
local goldObj
local currentGold = 0
pcall(function()
    goldObj = stats and stats:WaitForChild("gold_amount", 2)
end)
if goldObj and typeof(goldObj.Value)=="number" then
    currentGold = goldObj.Value
else
    warn("‡πÑ‡∏°‡πà‡∏û‡∏ö gold_amount => currentGold=0, ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ field ‡πÉ‡∏ô _stats ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ")
end

print("Current gold:", currentGold)

--------------------------------------------------------------------------------
-- (G) ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Level (spawn_units) + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á JSON ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠
--------------------------------------------------------------------------------

local function TryGetLevelOrSaved()
    local foundLevel = nil
    pcall(function()
        local spawnUnits = player:WaitForChild("PlayerGui", 5):WaitForChild("spawn_units", 2)
        local lvlObj = spawnUnits.Lives.Main.Desc:WaitForChild("Level", 2)
        foundLevel = lvlObj.Text
    end)
    -- ‡∏ñ‡πâ‡∏≤ foundLevel == nil => ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ => ‡πÉ‡∏ä‡πâ SavedLevel ‡πÄ‡∏î‡∏¥‡∏°
    if not foundLevel then
        return SavedLevel  -- ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ
    end
    -- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ foundLevel => ‡∏ï‡∏±‡∏î "Level " ‡∏≠‡∏≠‡∏Å
    local newLV = string.gsub(foundLevel, "Level ", "")
    -- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï LocalData + ‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
    LocalData.SavedLevel = newLV
    saveSettings(LocalData)
    return newLV
end

local currentLevel = TryGetLevelOrSaved()

--------------------------------------------------------------------------------
-- (G2) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Battle Pass Level (BP) + ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô SavedBP
--------------------------------------------------------------------------------

local function TryGetBPOrSaved()
    local foundBP = nil
    pcall(function()
        -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á GUI ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô PlayerGui.BattlePass.Main.Level.V
        local bpGui   = player:WaitForChild("PlayerGui", 5):WaitForChild("BattlePass", 2)
        local mainFrm = bpGui:WaitForChild("Main", 2)
        local lvFrm   = mainFrm:WaitForChild("Level", 2)
        local vLbl    = lvFrm:WaitForChild("V", 2)  -- ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥ Label ‡∏ä‡∏∑‡πà‡∏≠ V
        foundBP = vLbl.Text  -- ‡πÄ‡∏ä‡πà‡∏ô "50"
    end)

    if not foundBP then
        return SavedBP  -- ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ => ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    end
    if foundBP == "99" then
        return SavedBP
    end
    LocalData.SavedBP = foundBP
    saveSettings(LocalData)
    return foundBP
end

local currentBP = TryGetBPOrSaved()
--------------------------------------------------------------------------------
-- (G3) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Battle Pass Level (BP) + ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô SavedBP2
--------------------------------------------------------------------------------

local function TryGetBPOrSaved2()
    local foundBP2 = nil
    pcall(function()
        -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á GUI ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Player.PlayerGui.BattlePass.Main.FurthestRoom.V.Text,
        local bpGui2   = player:WaitForChild("PlayerGui", 5):WaitForChild("BattlePass", 2)
        local mainFrm2 = bpGui2:WaitForChild("Main", 2)
        local lvFrm2   = mainFrm2:WaitForChild("FurthestRoom", 2)
        local vLbl2    = lvFrm2:WaitForChild("V", 2)  -- ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥ Label ‡∏ä‡∏∑‡πà‡∏≠ V
        foundBP2 = vLbl2.Text  -- ‡πÄ‡∏ä‡πà‡∏ô "50"
    end)

    if not foundBP2 then
        return SavedBP2  -- ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ => ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    end
    if foundBP2 == "100000" or foundBP2 == "100000/100000" then
        return SavedBP2
    end
    LocalData.SavedBP2 = foundBP2
    saveSettings(LocalData)
    return foundBP2
end

local currentBP2 = TryGetBPOrSaved2()

--------------------------------------------------------------------------------
-- (H) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Webhook ‡πÅ‡∏•‡∏∞ WebhookEnd
--------------------------------------------------------------------------------
local LogoURLs = "https://cdn.discordapp.com/attachments/1082245350166892554/1323232911272448010/logo.png?ex=6773c42e&is=677272ae&hm=73bbda78feab2829609946c3dced71b8e6f9f544c3888a019a1ae5f304332588&"


local function sendWebhook(title, desc)
    local req = http_request or request or HttpPost or syn and syn.request
    if not req then
        warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => sendWebhook ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
        return
    end
    local payload = {
        content = "",
        embeds = {{
            title = title,
            description = desc,
            color = 0x00FF99,
            image = { url = ThumbnailURL },
            footer = { icon_url = LogoURLs , text = "PLaNS SHOP"},
            timestamp = DateTime.now():ToIsoDate()
        }}
    }
    req({
        Url = _G.Webhook,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end
--------------------------------------------------------------------------------
local function sendWebhook2(title, desc)
    local req = http_request or request or HttpPost or syn and syn.request
    if not req then
        warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => sendWebhook ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
        return
    end
    local payload = {
        content = "<@"..DiscordID.."> <@&1006505817769521177>",
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493,
            image = { url = ThumbnailURL },
            footer = { icon_url = LogoURLs , text = "PLaNS SHOP"},
            timestamp = DateTime.now():ToIsoDate()
        }}
    }
    req({
        Url = _G.Webhook,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end
--------------------------------------------------------------------------------
local function sendWebhookEnd(title, desc)
    local req = http_request or request or HttpPost or syn and syn.request
    if not req then
        warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => sendWebhookEnd ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß")
        return
    end
    local payload = {
        content = "<@"..DiscordID.."> <@&1006505817769521177>", 
        embeds = {{
            title = title,
            description = desc,
            color = 0xFF1493,
            image = { url = ThumbnailURL },
            footer = { icon_url = LogoURLs , text = "PLaNS SHOP"},
            timestamp = DateTime.now():ToIsoDate()
        }}
    }
    req({
        Url = WebhookEnd,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end

--------------------------------------------------------------------------------
-- (I) ‡∏™‡πà‡∏á Webhook ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏±‡∏ö MaxGems
--------------------------------------------------------------------------------

--[[sendWebhook(
    "PLaNS x ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏ä‡∏£",
    string.format(
        "üîí„ÉªUsername : ||**%s**||\n" ..
        "```md\n#Profile\n" ..
        "üü°„Éª‡∏ó‡∏≠‡∏á : %d\n" ..
        "üß™„Éª‡πÄ‡∏•‡πÄ‡∏ß‡∏• : %s\n" ..
        "üîã„Éª‡πÅ‡∏ö‡∏ó‡πÄ‡∏ó‡∏¥‡∏ô‡∏û‡∏≤‡∏™ : %s [%s]\n"..
        "üíé„Éª‡πÄ‡∏û‡∏ä‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ : %d\n" ..
        "- ‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ü‡∏≤‡∏° : [%d|%d]\n" ..
        "```\n" ..
        "```- ‡∏ü‡∏≤‡∏°‡πÄ‡∏û‡∏ä‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : %d ‡πÄ‡∏û‡∏ä‡∏£ üíé ```\n" ..
        "- ‡∏à‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì: <@%s>",
        player.Name,
        currentGold,
        currentLevel,
        currentBP,
        currentBP2,
        currentGems,
        currentGems,
        MaxGems,
        AddGemsWanted,
        DiscordID
    )
)]]

-- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£ => ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å MaxGems
if currentGems < OldGems then
    local diff = OldGems - currentGems
    LocalData.MaxGems = math.max(LocalData.MaxGems - diff, 0)
    print("‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏ä‡∏£", diff, "=> MaxGems =", LocalData.MaxGems)
elseif currentGems > OldGems then
    print("‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°", currentGems - OldGems, "=> OldGems:", OldGems, "->", currentGems)
end
LocalData.OldGems = currentGems

-- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ => ‡∏™‡πà‡∏á WebhookEnd
if currentGems >= LocalData.MaxGems
   and LocalData.MaxGems > 0
   and (not LocalData.IsSended)
then
    sendWebhookEnd(
        "- ‡∏ü‡∏≤‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞ <a:9828pinkpixelheart:1021714314446508082>",
        string.format(
            "üîí„ÉªUsername : ||**%s**||\n" ..
            "```md\n#Profile\n" ..
            "üíé„Éª‡πÄ‡∏û‡∏ä‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ : %d\n" ..
            "üü°„Éª‡∏ó‡∏≠‡∏á : %d\n" ..
            "üß™„Éª‡πÄ‡∏•‡πÄ‡∏ß‡∏• : %s\n" ..
            "üîã„Éª‡πÅ‡∏ö‡∏ó‡πÄ‡∏ó‡∏¥‡∏ô‡∏û‡∏≤‡∏™ : %s [%s]\n"..
            "- ‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß : [%d|%d]\n" ..
            "```\n" ..
            "```md\n#‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≤‡∏á\n- ‡∏ü‡∏≤‡∏°‡πÄ‡∏û‡∏ä‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : %d ‡πÄ‡∏û‡∏ä‡∏£ üíé ```\n\n" ..
            "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤¬∑ ö‚ô°…û¬∑\n[‡∏ù‡∏≤‡∏Å +1 ‡πÇ‡∏õ‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ü‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏á‡∏±‡∏ö](https://www.facebook.com/photo/?fbid=817544902138722&set=a.117678525458700)\n\n<a:emoji_98_jk:1054831096929452042> ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≤ <a:8699rightrainbowstar:1054740408434966588>",
            player.Name,
            currentGems,
            currentGold,
            currentLevel,
            currentBP,
            currentBP2,
            currentGems,
            MaxGems,
            AddGemsWanted
        )
    )
    LocalData.IsSended = true
end

saveSettings(LocalData)

-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô RunService
local RunService = game:GetService("RunService")

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠ GameFinished
local function WaitForGameFinished()
    local GameFinished
    pcall(function()
        -- ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ "_DATA" ‡∏à‡∏∞‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Workspace
        local DataFolder = game:GetService("Workspace"):WaitForChild("_DATA", 10)
        if DataFolder then
            GameFinished = DataFolder:WaitForChild("GameFinished", 10)
        end
    end)
    if not GameFinished then
        warn("‡πÑ‡∏°‡πà‡∏û‡∏ö GameFinished ‡πÉ‡∏ô Workspace")
    end
    return GameFinished
end

-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô WaitForGameFinished ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ GameFinished
local GameFinished = WaitForGameFinished()

-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Webhook ‡∏ã‡πâ‡∏≥
local WebhookSent = false

if GameFinished then
    -- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á Webhook
    local function SendGameFinishedWebhook()
        -- ‡πÄ‡∏ä‡πá‡∏Ñ GameFinished.Value
        if GameFinished.Value == true and not WebhookSent then
            -- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤ Webhook ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
            WebhookSent = true

            --task.wait(2)
            -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Webhook
            
            local Player = game:GetService("Players").LocalPlayer
            local UnitInfo = Player.PlayerGui:WaitForChild("UnitInfo", 10)
            local Level, Gem, GemPath, GoldPath, XP, TitlePath, DescPath, DiffPath
            local WaveCompleted, TimeCompleted, TotalGems, InfoGameEnd, KillsInGame = nil
            local AllItem = ""

            -- ‡πÉ‡∏ä‡πâ pcall ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            pcall(function()
                Level = Player.PlayerGui["spawn_units"].Lives.Main.Desc.Level.Text
                Gem = Player.PlayerGui.ResultsUI.Holder.LevelRewards.ScrollingFrame.GemReward.Main.Amount.Text
                GemPath = Player["_stats"]["gem_amount"]
                GoldPath = Player["_stats"]["gold_amount"]
                XP = Player.PlayerGui.ResultsUI.Holder.LevelRewards.ScrollingFrame.XPReward.Main.Amount.Text
                TitlePath = Player.PlayerGui.NewArea.holder.areaTitle
                DescPath = Player.PlayerGui.NewArea.holder.areaDescription
                DiffPath = Player.PlayerGui.NewArea.holder.Difficulty
                WaveCompleted = Player.PlayerGui.ResultsUI.Holder.Middle.WavesCompleted.Text
                TimeCompleted = Player.PlayerGui.ResultsUI.Holder.Middle.Timer.Text
                TotalGems = GemPath.Value
                InfoGameEnd = Player.PlayerGui.ResultsUI.Holder.Title.Text
                KillsInGame = Player["_stats"].kills.Value
                
                --game:GetService("Players").LocalPlayer.PlayerGui.UnitInfo.holder.info1.UnitName.UnitNameText.text
                -- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                --[[local UnitInfo = Player.PlayerGui.UnitInfo
                if UnitInfo and UnitInfo:FindFirstChild("holder") and UnitInfo.holder:FindFirstChild("info1") then
                    UnitInfo.holder.info1.UnitName.UnitNameText:GetPropertyChangedSignal("Text"):Connect(function()
                        local ItemName = UnitInfo.holder.info1.UnitName.UnitNameText.text
                        AllItem = AllItem .. "‚óà " .. ItemName .. "\n"
                    end)
                end]]

                local Player = game:GetService("Players").LocalPlayer
                local UnitInfo = Player.PlayerGui:WaitForChild("UnitInfo", 10)

                -- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á UnitInfo
                if UnitInfo and UnitInfo:FindFirstChild("holder") then
                    local holder = UnitInfo.holder
                    if holder:FindFirstChild("info1") then
                        local info1 = holder.info1
                        if info1:FindFirstChild("UnitName") then
                            local UnitName = info1.UnitName
                            if UnitName:FindFirstChild("UnitNameText") then
                                local UnitNameText = UnitName.UnitNameText

                                -- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô TextLabel ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Text
                                if UnitNameText:IsA("TextLabel") then
                                    -- ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                                    local initialItemName = UnitNameText.Text
                                    AllItem = AllItem .. "‚óà " .. initialItemName .. "\n"
                                    print("Initial Item Name:", initialItemName)

                                    -- ‡∏ï‡∏±‡πâ‡∏á Listener ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
                                    UnitNameText:GetPropertyChangedSignal("Text"):Connect(function()
                                        local updatedItemName = UnitNameText.Text
                                        AllItem = AllItem .. "‚óà " .. updatedItemName .. "\n"
                                        print("Item Name Updated:", updatedItemName)
                                    end)
                                else
                                    warn("UnitNameText is not a TextLabel!")
                                end
                            else
                                warn("UnitNameText not found!")
                            end
                        else
                            warn("UnitName not found!")
                        end
                    else
                        warn("info1 not found!")
                    end
                else
                    warn("UnitInfo or holder not found!")
                end
            end)




            local function GetCurrentLevel()
                return (string.gsub(Level or "Level ???", "Level ", ""))
            end

            local function GetNum(str)
                return string.match(str, "%d+")
            end

            -- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Webhook
            local descFormat = "üîí„ÉªUsername : ||%s||\n```md\n#Profile\nüíé„Éª‡πÄ‡∏û‡∏ä‡∏£ : %s\nüü°„Éª‡∏ó‡∏≠‡∏á : %s\nüß™„Éª‡πÄ‡∏•‡πÄ‡∏ß‡∏•: %s\nüîã„Éª‡πÅ‡∏ö‡∏ó‡πÄ‡∏ó‡∏¥‡∏ô‡∏û‡∏≤‡∏™ : %s [%s]```\n"
                .. "```md\n#Game Infomation\n- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô : %s\n- ‡πÅ‡∏°‡∏û : %s\n- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å : %s\n- ‡πÄ‡∏ß‡∏ü : %s | %s```\n"
                .. "```md\n#Enemies Killed\n- %d```\n"
                .. "```md\n#Rewards:\n‚óà %s üíé\n‚óà %s üçÄ\n%s```\n"
                .. "```md\n#‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≤‡∏á\n- ‡∏ü‡∏≤‡∏°‡πÄ‡∏û‡∏ä‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : %d ‡πÄ‡∏û‡∏ä‡∏£ üíé\n- ‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ü‡∏≤‡∏° : [%d|%d]```\n"
                .. "- ‡∏à‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì: <@%s>"

            local finalDesc = string.format(
                descFormat,
                Player.Name,
                GemPath and GemPath.Value or "N/A",
                GoldPath and GoldPath.Value or "N/A",
                GetCurrentLevel(),
                currentBP,
                currentBP2,
                InfoGameEnd or "N/A",
                (TitlePath and TitlePath.Text or "N/A") .. "\n- ‡πÇ‡∏´‡∏°‡∏î : " .. (DescPath and DescPath.Text or "N/A"),
                DiffPath and DiffPath.Text or "N/A",
                GetNum(WaveCompleted) or "0",
                TimeCompleted or "N/A",
                KillsInGame or 0,
                Gem or "N/A",
                XP or "N/A",
                AllItem,
                AddGemsWanted,
                tostring(TotalGems or 0),
                MaxGems,
                DiscordID
            )

            -- ‡∏™‡πà‡∏á Webhook
            local req = http_request or request or HttpPost or syn and syn.request
            if req then
                local BodyJson = {
                    content = "",
                    embeds = {
                        {
                            title = "** <a:lp:1054740345709146182>  ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤ <a:lp:1054740345709146182>  **",
                            description = finalDesc,
                            type = "rich",
                            color = 0x33FFCC,
                            image = { url = ThumbnailURL },
                            footer = { icon_url = LogoURLs , text = "PLaNS SHOP"},
                            timestamp = DateTime.now():ToIsoDate()
                        }
                    }
                }

                req({
                    Url = _G.Webhook,
                    Method = "POST",
                    Headers = { ["Content-Type"] = "application/json" },
                    Body = game.HttpService:JSONEncode(BodyJson)
                })
            else
                warn("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô request => ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á Webhook ‡πÑ‡∏î‡πâ")
            end
        end
    end

    -- ‡πÉ‡∏ä‡πâ RunService.Stepped ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GameFinished.Value
    RunService.Stepped:Connect(function()
        if GameFinished.Value == true then
            task.delay(3.5, function()
                SendGameFinishedWebhook()
            end)
        elseif GameFinished.Value == false and WebhookSent then
            -- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï WebhookSent ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤ GameFinished ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô false
            WebhookSent = false
        end
    end)
else
    print("‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡πä‡∏≠‡∏ö‡∏ö‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ GameFinished")
end 


--------------------------------------------------------------------------------
-- (J) ‡∏™‡∏£‡πâ‡∏≤‡∏á UI (Lib): "Add Gems" => MaxGems = currentGems + AddGemsWanted
--------------------------------------------------------------------------------

local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/EmiyaSanZ/Lib/main/UI'))()
local Window  = Library:CreateWindow({
    Title    = "PLaNS x SHOP",
    Center   = true,
    AutoShow = false,
})

local MainTab     = Window:AddTab("PLaNS x SHOP")
local SettingsBox = MainTab:AddLeftGroupbox("Settings")

-- Input ‚ÄúAdd Gems‚Äù
local addGemsInput = SettingsBox:AddInput('Add Gems', {
    Numeric     = true,
    Finished    = false,
    Text        = '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏µ‡πà‡πÄ‡∏û‡∏ä‡∏£?',
    Placeholder = 'Ex: 20000',
    Default     = AddGemsWanted
})

-- Input ‚ÄúDiscord ID‚Äù
local di = SettingsBox:AddInput('Discord ID', {
    Numeric     = false,
    Finished    = false,
    Text        = 'Discord ID',
    Placeholder = 'Ex: 12345678',
    Default     = DiscordID
})

-- ‡∏õ‡∏∏‡πà‡∏° Save
SettingsBox:AddButton('Save Settings', function()
    local addGemsNum = tonumber(addGemsInput.Value) or 0
    LocalData.MaxGems       = currentGems + math.max(addGemsNum, 0)
    LocalData.DiscordID     = di.Value
    LocalData.AddGemsWanted = addGemsNum
    LocalData.IsSended      = false

    if typeof(LocalData.OldGems) ~= "number" then
        LocalData.OldGems = 0
    end
    if LocalData.OldGems == 0 then
        LocalData.OldGems = currentGems
    end

    saveSettings(LocalData)

    -- << ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DiscordID ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏î‡πâ‡∏ß‡∏¢ >>
    DiscordID = di.Value    -- <<--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    print(string.format(
        "[Save] AddGemsWanted=%d => MaxGems=%d, DiscordID=%s",
        addGemsNum, LocalData.MaxGems, LocalData.DiscordID
    ))
end)

local dd = LocalData.DiscordID or ""
-- ‡∏õ‡∏∏‡πà‡∏° Test
SettingsBox:AddButton('Test Webhook', function()
    local testStr = string.format(
        "‡∏ó‡∏î‡∏™‡∏≠‡∏ö!\n‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô : ||%s||\n- ‡∏ó‡∏≠‡∏á : %d\n- ‡πÄ‡∏•‡πÄ‡∏ß‡∏• : %s\n- ‡πÄ‡∏ß‡∏•‡πÅ‡∏ö‡∏ó‡πÄ‡∏ó‡∏¥‡∏ô‡∏û‡∏≤‡∏™ : %s [%s]\n- ‡πÄ‡∏û‡∏ä‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ : %d\n- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ : %d\n\n```md\n#‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≤‡∏á\n- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : %d ‡πÄ‡∏û‡∏ä‡∏£```",
        player.Name,
        currentGold,
        currentLevel,  -- ‡πÉ‡∏ä‡πâ Level ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠)
        currentBP,
        currentBP2,
        currentGems,
        LocalData.MaxGems,
        LocalData.AddGemsWanted
    )
    sendWebhook2("<a:alert:1021734820461674527> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÜ <a:alert:1021734820461674527>", testStr .. "<@"..dd..">")
end)

-- Toggle White Screen
SettingsBox:AddLabel("Optional UI Toggles")
local WhiteScreenToggle = SettingsBox:AddToggle('White Screen', {
    Text    = 'Toggle White Screen',
    Default = false,
})
WhiteScreenToggle:OnChanged(function(v)
    RunService:Set3dRenderingEnabled(not v)
end)

--------------------------------------------------------------------------------
-- (K) ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Toggle UI
--------------------------------------------------------------------------------

--[[do
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "UI_ToggleButton"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    ScreenGui.DisplayOrder = 9999

    -- ‡πÉ‡∏™‡πà Parent = PlayerGui
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    local ToggleButton = Instance.new("ImageButton")
    ToggleButton.Name = "ToggleButton"
    ToggleButton.Size = UDim2.new(0, 50, 0, 50)
    ToggleButton.Position = UDim2.new(0, 10, 0.5, -25)
    ToggleButton.BackgroundTransparency = 1
    ToggleButton.Image = "rbxassetid://3570695787"
    ToggleButton.Parent = ScreenGui

    ToggleButton.MouseButton1Click:Connect(function()
        Library.Toggle()
    end)
end]]
do
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "UI_ToggleButton"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    ScreenGui.DisplayOrder = 9999

    -- ‡πÉ‡∏™‡πà Parent = PlayerGui
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    local ToggleButton = Instance.new("ImageButton")
    ToggleButton.Name = "ToggleButton"
    ToggleButton.Size = UDim2.new(0, 25, 0, 25)
    ToggleButton.Position = UDim2.new(0, 10, 0.5, -25)
    ToggleButton.BackgroundTransparency = 0 -- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 182, 255) -- ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô (Light Pink)
    ToggleButton.ImageTransparency = 1 -- ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    ToggleButton.Parent = ScreenGui

    ToggleButton.MouseButton1Click:Connect(function()
        Library.Toggle()
    end)
end



print("Script loaded! ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ spawn_units => ‡πÉ‡∏ä‡πâ Level ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå SavedLevel ‡πÅ‡∏ó‡∏ô ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà.") 
